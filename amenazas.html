<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Story Map sobre las Amenazas Clim√°ticas en Tlaxcala"
    />
    <title>Amenazas Clim√°ticas - Tlaxcala</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/story-map.css" />

    <style>
      /* Sobrescribir estilos para gr√°ficas del cap√≠tulo 2 al 100% del ancho */
      #chapter-2 .analytics-chart-1 .chart-container,
      #chapter-2 .analytics-chart-2 .chart-container {
        width: 100% !important;
        max-width: none !important;
        max-height: none !important;
        height: calc(100% - 2rem) !important;
        margin: 0 !important;
      }

      #chapter-2 .analytics-chart-1 canvas,
      #chapter-2 .analytics-chart-2 canvas {
        width: 100% !important;
        height: 100% !important;
      }

      #chapter-2 .analytics-chart-1,
      #chapter-2 .analytics-chart-2 {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #chapter-2 .analytics-chart-1 .chart-title,
      #chapter-2 .analytics-chart-2 .chart-title {
        flex-shrink: 0;
        margin-bottom: 0.5rem;
      }

      /* Layout especial para cap√≠tulo 4 - Sequ√≠a (una sola card a la derecha) */
      .chapter-sequia {
        display: grid;
        grid-template-columns: 30% 70%;
        grid-template-rows: auto 1fr;
        gap: 0.5rem;
        padding: 1rem;
      }

      .chapter-sequia .map-title {
        grid-column: 1 / -1;
        grid-row: 1;
      }

      .chapter-sequia .chapter-text {
        grid-column: 1;
        grid-row: 2;
      }

      .chapter-sequia .chapter-chart-full {
        grid-column: 2;
        grid-row: 2;
        background: white;
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: 0 4px 15px var(--color-shadow-md);
        border: 1px solid var(--color-beige-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chapter-sequia .chapter-chart-full .chart-title {
        flex-shrink: 0;
        margin-bottom: 0.5rem;
      }

      .chapter-sequia .chapter-chart-full .chart-container {
        flex: 1;
        width: 100% !important;
        max-width: none !important;
        max-height: none !important;
        min-height: 0;
        position: relative;
      }

      .chapter-sequia .chapter-chart-full canvas {
        width: 100% !important;
        height: 100% !important;
      }

      /* Estilos para gr√°ficas del cap√≠tulo 5 - Heladas */
      #chapter-5 .analytics-chart-1 .chart-container {
        width: 100% !important;
        max-width: none !important;
        max-height: none !important;
        height: calc(100% - 2rem) !important;
        margin: 0 !important;
      }

      #chapter-5 .analytics-chart-1 canvas {
        width: 100% !important;
        height: 100% !important;
      }

      #chapter-5 .analytics-chart-1 {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #chapter-5 .analytics-chart-1 .chart-title {
        flex-shrink: 0;
        margin-bottom: 0.5rem;
      }
    </style>

    <!-- OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <!-- Papa Parse para CSVs -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <!--         <span class="navbar-brand-icon">&#127757;</span> -->
          <span>Tlaxcala</span>
        </a>

        <button class="navbar-toggle" id="navbarToggle" aria-label="Abrir men√∫">
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
        </button>

        <div class="navbar-menu" id="navbarMenu">
          <a href="index.html" class="navbar-link">Inicio</a>
          <a href="vulnerabilidad.html" class="navbar-link">Vulnerabilidad</a>
          <a href="riesgo.html" class="navbar-link">Riesgo</a>
          <a href="amenazas.html" class="navbar-link active">Amenazas</a>
          <a href="impactos.html" class="navbar-link">Impactos</a>
          <a href="clima.html" class="navbar-link">Clima</a>
          <a href="escenarios_clima.html" class="navbar-link">Escenarios Clim√°ticos</a>
          <a href="acciones-climaticas.html" class="navbar-link">Acciones Clim√°ticas</a>
          <a href="mitigacion.html" class="navbar-link">Mitigaci√≥n</a>
        </div>
      </div>
    </nav>

    <!-- Indicador para mostrar el navbar -->
    <div class="navbar-indicator" id="navbarIndicator"></div>

    <!-- Contenedor principal del Story Map -->
    <div class="story-map-container">
      <!-- Contenedor de cap√≠tulos con scroll-snap -->
      <div class="chapters-container" id="chaptersContainer">
        <!-- CAP√≠TULO 1 -->
        <section class="chapter" id="chapter-1" data-chapter="1">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Amenazas clim√°ticas por municipio</h2>

          <!-- Mapa -->
          <div class="chapter-map">
            <div class="map-container" id="map-1"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text">
            <!-- <span class="chapter-number">Cap√≠tulo 1</span> -->
            <h2 class="chapter-title">
              ¬øQu√© es una Amenaza?
            </h2>
            <div class="chapter-content">
              <p>
                Se refiere a cualquier evento o fen√≥meno que tiene el potencial de causar da√±o o perjuicio.
              </p>
              <p>
                Las amenazas pueden ser naturales, como huracanes, terremotos o inundaciones, o pueden ser antropog√©nicas, como la contaminaci√≥n o el conflicto armado. 
              </p>
              <p>
                En el contexto del cambio clim√°tico, las amenazas incluyen el aumento de la temperatura, el cambio en los patrones de precipitaci√≥n y la ocurrencia de fen√≥menos clim√°ticos extremos.
              </p>
            </div>
          </div>

<!-- Card combinada de gr√°fico e info (sin borde entre ellas) -->
<div class="chapter-chart-info">
  <!-- T√≠tulo √∫nico para toda la card -->
<!--   <h2 class="chart-info-title">Poblaci√≥n expuesta a amenazas clim√°ticas</h2> -->

  <div class="chart-info-content">
    <!-- Secci√≥n del gr√°fico -->
<!--     <div class="chart-section">
      <div class="chart-container">
        <canvas id="chart-1"></canvas>
      </div>
    </div> -->

    <!-- Secci√≥n de texto explicativo -->
<!--     <div class="info-section">
      <div class="info-content">
        <p>
          Las amenazas clim√°ticas son eventos hidrometeorol√≥gicos extremos que pueden impactar negativamente a la poblaci√≥n y al territorio. La identificaci√≥n y el an√°lisis de estas amenazas son fundamentales para la planificaci√≥n territorial y la gesti√≥n del riesgo. Para conocer a detalle las variables y su an√°lisis, te invitamos a consultar el PACCET 2023-2030.
        </p>
      </div>
    </div> -->
  </div>
</div>
        </section>

        <!-- CAP√çTULO 2 -->
        <section class="chapter chapter-analytics" id="chapter-2" data-chapter="2">
          <!-- T√≠tulo del cap√≠tulo -->
          <h2 class="map-title">An√°lisis de Amenazas Clim√°ticas</h2>

          <!-- Card de texto (izquierda, 30%) -->
          <div class="analytics-text">
            <h2 class="chapter-title">Diagn√≥stico Participativo</h2>
            <div class="chapter-content">
              <p>
                En los talleres de diagn√≥stico, representantes de distintos sectores (acad√©micos, industriales, poblaci√≥n general y autoridades) identificaron los <strong>eventos clim√°ticos ocurridos</strong>, los <strong>riesgos m√°s frecuentes</strong> y las <strong>estrategias de protecci√≥n</strong> necesarias para Tlaxcala, tanto de manera presencial como en l√≠nea.
              </p>
              <p>
                Los resultados muestran <strong>consistencia entre el an√°lisis de vulnerabilidad y el conocimiento local</strong>: municipios como <strong>Altzayanca</strong> (vulnerabilidad "Muy alta") y <strong>Tlaxco</strong> (mayor cantidad de riesgos mencionados) coinciden con altos niveles de pobreza extrema. Esto confirma que <strong>la vulnerabilidad se acent√∫a en las localidades m√°s pobres</strong>, donde la falta de capacidad adaptativa convierte eventos naturales en cat√°strofes.
              </p>
            </div>
          </div>

          <!-- Card gr√°fica superior (derecha arriba, 70%) -->
          <div class="analytics-chart-1">
            <h3 class="chart-title">Frecuencia de Eventos que se han presentado en el estado de Tlaxcala</h3>
            <div class="chart-container">
              <canvas id="chart-2-1"></canvas>
            </div>
          </div>

          <!-- Card gr√°fica inferior (derecha abajo, 70%) -->
          <div class="analytics-chart-2">
            <h3 class="chart-title">Frecuencia de menci√≥n de riesgos identificados por municipio</h3>
            <div class="chart-container">
              <canvas id="chart-2-2"></canvas>
            </div>
          </div>
        </section>

        <!-- CAP√çTULO 3 -->
        <section class="chapter amenazas-chapter-3" id="chapter-3" data-chapter="3">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Distribuci√≥n espacial de amenazas clim√°ticas</h2>

          <!-- Mapa -->
          <div class="chapter-map amenazas-chapter-map">
            <div class="map-container" id="map-3"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text amenazas-chapter-text">
            <h2 class="chapter-title">Impacto Territorial</h2>
            <div class="chapter-content">
              <p>
               <ul>
                <li><strong>üåµ Sequ√≠a:</strong>Entre 2010 y 2023 prevalecieron condiciones de sequ√≠a "anormalmente seca" (D0), ligadas a la disminuci√≥n de lluvias en la regi√≥n. <br>üîóFuente: <a href="https://smn.conagua.gob.mx/es/climatologia/monitor-de-sequia/monitor-de-sequia-en-mexico" target="_blank">Monitor de sequ√≠as CONAGUA</a></li>
                <li><br></li>
                <li><strong>üî• Fuegos forestales:</strong>Registrados en distintas zonas del estado, con informaci√≥n detallada en el SNIF. <br>üîóFuente: <a href="https://snif.cnf.gob.mx/incendios/" target="_blank">Incendios forestales ‚Äì SNIF</a></li>
                <li><br></li>
                <li><strong>üåä Inundaciones:</strong>Identificadas como amenazas recurrentes en varios municipios. <br>üîóDatos disponibles en: <a href="http://www.atlasnacionalderiesgos.gob.mx/archivo/visor-capas.html" target="_blank">Atlas Nacional de Riesgos</a></li>
                <li><br></li>
                <li><strong>üå≤ Deforestaci√≥n:</strong>Vinculada a la p√©rdida de cobertura vegetal y al aumento de la vulnerabilidad del territorio. <br>üîóFuente: <a href="https://snmf.cnf.gob.mx/sistema-nacional-de-monitoreo-forestal-2/" target="_blank">Sistema Nacional de Monitoreo Forestal</a></li>
                <li><br></li>
                <li><strong>üè≠ Emisi√≥n de contaminantes:</strong>Mencionada como amenaza, pero se recomienda moverla a la secci√≥n de Mitigaci√≥n por su relaci√≥n con reducci√≥n de emisiones y calidad del aire. <br>üîóFuente: <a href="https://gisviewer.semarnat.gob.mx/wmaplicacion/inem/" target="_blank">Inventario Nacional de Emisiones - SEMARNAT</a></li>
               </ul>
              </p>
            </div>
          </div>
        </section>

        <!-- CAP√çTULO 4 -->
        <section class="chapter chapter-sequia" id="chapter-4" data-chapter="4">
          <!-- T√≠tulo del cap√≠tulo -->
          <h2 class="map-title">Amenazas al sector agr√≠cola: Sequ√≠a</h2>

          <!-- Card de texto (izquierda, 30%) -->
          <div class="chapter-text">
            <h2 class="chapter-title">Agricultura y Sequ√≠a</h2>
            <br>
            <br>
                        <div class="chapter-content">
              <p>
                La <strong>agricultura</strong> es fundamental para la producci√≥n de alimentos, fibras y materiales. Incluye actividades como preparaci√≥n del suelo, siembra, riego, fertilizaci√≥n, control de plagas y cosecha. En Tlaxcala existen diversos tipos: de subsistencia, comercial, de regad√≠o y org√°nica.
              </p>
              <p>
                La <strong>sequ√≠a</strong> es un fen√≥meno clim√°tico caracterizado por escasez prolongada de lluvias y humedad insuficiente. Sus efectos en la agricultura son devastadores: <strong>p√©rdida de cultivos, disminuci√≥n de producci√≥n de alimentos</strong> y escasez de agua para riego, generando p√©rdida de ingresos e inseguridad alimentaria.
              </p>
              <p>
                Entre <strong>2010 y 2023</strong>, seg√∫n el Monitor de Sequ√≠as, en Tlaxcala ha prevalecido principalmente la condici√≥n <strong>"Anormalmente seco" (D0)</strong>, atribuida a la disminuci√≥n de lluvias en la regi√≥n durante dicho periodo.
              </p>
            </div>
          </div>

          <!-- Card gr√°fica √∫nica (derecha, 70%) -->
          <div class="chapter-chart-full">
            <h3 class="chart-title">Evoluci√≥n y el porcentaje de √°rea del Estado afectado con una o varias categor√≠as de sequ√≠a</h3>
            <div class="chart-container">
              <canvas id="chart-4-1"></canvas>
            </div>
          </div>
        </section>

        <!-- CAP√çTULO 5 -->
        <section class="chapter chapter-analytics" id="chapter-5" data-chapter="5">
          <!-- T√≠tulo del cap√≠tulo -->
          <h2 class="map-title">Amenazas al sector agr√≠cola: Helada</h2>

          <!-- Card de texto (izquierda, 30%) -->
          <div class="analytics-text">
            <h2 class="chapter-title">Heladas</h2>
            <br>
            <div class="chapter-content">
              <p>
                Las heladas representan un riesgo para cultivos sensibles al fr√≠o.
              </p>
              <p>
                Tlaxcala experimenta un n√∫mero variable de d√≠as con heladas (FD0) cada a√±o, lo que exige medidas de protecci√≥n para evitar da√±os significativos a las cosechas.
              </p>
            </div>
          </div>

          <!-- Card gr√°fica superior (derecha arriba, 70%) -->
          <div class="analytics-chart-1">
            <h3 class="chart-title">N√∫mero de d√≠as de heladas (FD0)</h3>
            <div class="chart-container">
              <canvas id="chart-5-1"></canvas>
            </div>
          </div>

          <!-- Card mapa inferior (derecha abajo, 70%) -->
          <div class="analytics-chart-2 analytics-map">
            <div class="map-container" id="map-5"></div>
          </div>
        </section>
      </div>

      <!-- Timeline inferior -->
      <div class="timeline" id="timeline">
        <div class="timeline-item" data-chapter="1">
          <div class="timeline-circle">1</div>
          <div class="timeline-label">Amenazas clim√°ticas</div>
        </div>
        <div class="timeline-item" data-chapter="2">
          <div class="timeline-circle">2</div>
          <div class="timeline-label">An√°lisis y Tendencias</div>
        </div>
        <div class="timeline-item" data-chapter="3">
          <div class="timeline-circle">3</div>
          <div class="timeline-label">Impacto Territorial</div>
        </div>
        <div class="timeline-item" data-chapter="4">
          <div class="timeline-circle">4</div>
          <div class="timeline-label">Amenazas: Sequ√≠a</div>
        </div>
        <div class="timeline-item" data-chapter="5">
          <div class="timeline-circle">5</div>
          <div class="timeline-label">Amenazas: Heladas</div>
        </div>
      </div>

      <!-- Botones de navegaci√≥n -->
      <div class="nav-buttons left" id="navButtonsLeft">
        <button class="nav-btn" id="btnPrev" aria-label="Cap√≠tulo anterior">
          ‚Üê
        </button>
      </div>
      <div class="nav-buttons right" id="navButtonsRight">
        <button class="nav-btn" id="btnNext" aria-label="Siguiente cap√≠tulo">
          ‚Üí
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
      import { storyMapConfig } from './js/config/amenazas-config.js';

      // ============================================================
      // INICIALIZACI√ìN PRINCIPAL
      // ============================================================
      window.addEventListener('DOMContentLoaded', () => {
        const capituloActual = storyMapConfig.capitulos[0];
        const proxyUrl = storyMapConfig.proxyUrl;

        // ============================================================
        // CAP√çTULO 1 - MAPA DE AMENAZAS CLIM√ÅTICAS
        // ============================================================
        const map = new ol.Map({
          target: 'map-1',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
              zIndex: 0, 
            }),
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat(capituloActual.mapa.centro),
            zoom: capituloActual.mapa.zoom,
          }),
          controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: false,
          }),
        });


        const capasWMS = [];

        // Detectar si estamos usando proxy de Vercel
        const isVercelProxy = proxyUrl.includes('proxy?path=');

        // Agregar capas WMS
        capituloActual.mapa.capas.forEach((capaConfig, index) => {

          if (capaConfig.tipo === 'subtitulo') {
            capasWMS.push(null);
            return;
          }

          if (capaConfig.tipo === 'wms') {
            const workspace = 'SEICCT';
            let wmsSource;

            if (isVercelProxy) {
              // Para Vercel: usar tileLoadFunction personalizado
              const basePath = `/geoserver/${workspace}/wms`;
              wmsSource = new ol.source.TileWMS({
                url: proxyUrl.replace('?path=', ''),
                params: {
                  'LAYERS': capaConfig.layer,
                  'TILED': true,
                  'VERSION': '1.1.0',
                  'FORMAT': 'image/png',
                  'TRANSPARENT': true,
                },
                serverType: 'geoserver',
                crossOrigin: 'anonymous',
                tileLoadFunction: function(imageTile, src) {
                  const url = new URL(src, window.location.origin);
                  const params = url.searchParams.toString();
                  const fullPath = `${basePath}?${params}`;
                  const encodedPath = encodeURIComponent(fullPath);
                  const finalUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                  imageTile.getImage().src = finalUrl;
                },
              });
            } else {
              // Para local: URL directa
              wmsSource = new ol.source.TileWMS({
                url: proxyUrl + '/SEICCT/wms',
                params: {
                  'LAYERS': capaConfig.layer,
                  'TILED': true,
                },
                serverType: 'geoserver',
              });
            }

            const wmsLayer = new ol.layer.Tile({
              source: wmsSource,
              visible: capaConfig.visible || false,
              opacity: capaConfig.opacity || 1,
              zIndex: capaConfig.zIndex || index,
            });
            wmsLayer.set('name', capaConfig.nombre);
            map.addLayer(wmsLayer);
            capasWMS.push(wmsLayer);
          }


          if (capaConfig.tipo === 'wfs') {
            const typeName = capaConfig.layers;
            const layerParts = typeName.split(':');
            const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

            const vectorSource = new ol.source.Vector({
              format: new ol.format.GeoJSON(),
              url: function(extent) {
                const params = new URLSearchParams({
                  service: 'WFS',
                  version: '1.0.0',
                  request: 'GetFeature',
                  typeName: typeName,
                  outputFormat: 'application/json',
                  srsname: 'EPSG:3857',
                  bbox: `${extent.join(',')},EPSG:3857`
                });

                if (isVercelProxy) {
                  // Para Vercel: URL-encode el path completo
                  const wfsPath = `/geoserver/${workspace}/ows?${params.toString()}`;
                  const encodedPath = encodeURIComponent(wfsPath);
                  return `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                } else {
                  // Para local
                  return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
                }
              },
              strategy: ol.loadingstrategy.bbox
            });

            
            const transparentStyle = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 0, 0)',
                width: 0
              }),
              fill: new ol.style.Fill({
                color: 'rgba(0, 0, 0, 0)'
              })
            });

            const wfsLayer = new ol.layer.Vector({
              source: vectorSource,
              style: transparentStyle,
              visible: true,
              zIndex: 999
            });
            wfsLayer.set('name', capaConfig.nombre);
            wfsLayer.set('tipo', 'wfs');
            map.addLayer(wfsLayer);

            
            configurarHoverMunicipios(map);

            capasWMS.push(null); // Mantener √≠ndice
          }
        });

        generarControlesCapas(capituloActual.mapa.capas, capasWMS);

        /**
         * Configura el hover sobre municipios para mostrar tooltip
         * @param {ol.Map} mapa - Instancia del mapa de OpenLayers
         */
        function configurarHoverMunicipios(mapa) {
          const mapElement = document.getElementById('map-1');
          if (!mapElement) return;

          
          const tooltip = document.createElement('div');
          tooltip.className = 'municipio-hover-tooltip';
          tooltip.style.display = 'none';
          mapElement.appendChild(tooltip);

          
          let currentFeature = null;
          let defaultStyle = null;

          
          const hoverStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: '#A21A5C',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'rgba(162, 26, 92, 0.2)'
            })
          });

          
          mapa.on('pointermove', (evt) => {
            const pixel = mapa.getEventPixel(evt.originalEvent);

            
            if (currentFeature) {
              currentFeature.setStyle(defaultStyle);
              currentFeature = null;
              tooltip.style.display = 'none';
            }

            
            mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
              if (layer && layer.get('tipo') === 'wfs') {
                currentFeature = feature;
                defaultStyle = feature.getStyle() || layer.getStyle();

                
                feature.setStyle(hoverStyle);

                
                const properties = feature.getProperties();
                const nombreMunicipio =
                  properties.Municipio ||
                  properties.MUNICIPIO ||
                  properties.municipio ||
                  properties.nombre ||
                  properties.NOMBRE ||
                  properties.NOM_MUN ||
                  properties.nom_mun ||
                  properties.NOMGEO ||
                  properties.nomgeo ||
                  'Municipio';

                
                tooltip.textContent = nombreMunicipio;
                tooltip.style.display = 'block';
                tooltip.style.left = `${evt.originalEvent.offsetX + 15}px`;
                tooltip.style.top = `${evt.originalEvent.offsetY + 15}px`;

                return true; 
              }
            });
          });
        }

        /**
         * Genera el panel de control de capas con checkboxes
         * @param {Array} capasConfig - Configuraci√≥n de capas desde amenazas-config.js
         * @param {Array} capasWMS - Array de capas WMS de OpenLayers
         */
        function generarControlesCapas(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-1');
          if (!mapContainer || !mapContainer.parentElement) return;

          
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

          
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

          
          capasConfig.forEach((capaConfig, index) => {
            
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

            
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

            
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

            
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                
                actualizarPanelLeyendas(capasConfig, capasWMS);
              });
            }
          });

          
          crearPanelLeyendas(mapContainer.parentElement);
          
          actualizarPanelLeyendas(capasConfig, capasWMS);
        }

        /**
         * Crea el panel de leyendas en el mapa
         * @param {HTMLElement} mapParent - Elemento padre donde se agregar√° el panel
         */
        function crearPanelLeyendas(mapParent) {
          let legendsContainer = mapParent.querySelector('.map-legends');
          if (!legendsContainer) {
            legendsContainer = document.createElement('div');
            legendsContainer.className = 'map-legends';
            legendsContainer.innerHTML = `
              <div class="map-legends-header">
                <div class="map-legends-title">Leyendas</div>
                <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
              </div>
              <div class="map-legends-content"></div>
            `;
            mapParent.appendChild(legendsContainer);

            
            const toggleBtn = legendsContainer.querySelector('.map-legends-toggle');
            toggleBtn.addEventListener('click', () => {
              legendsContainer.classList.toggle('collapsed');
              toggleBtn.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            });
          }
        }

        /**
         * Genera HTML de simbolog√≠a manual desde configuraci√≥n
         * @param {Object} simbologia - Configuraci√≥n de simbolog√≠a
         * @returns {string} HTML de la simbolog√≠a
         */
        function generarSimbologiaHTML(simbologia) {
          let html = '<div class="legend-simbologia">';
          simbologia.categorias.forEach(cat => {
            html += `
              <div class="legend-categoria">
                <span class="legend-simbolo" style="background-color: ${cat.color}; border: 1px solid ${cat.stroke || '#333'};"></span>
                <span class="legend-label">${cat.label}</span>
              </div>
            `;
          });
          html += '</div>';
          return html;
        }

        /**
         * Actualiza el panel de leyendas mostrando solo las capas activas
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function actualizarPanelLeyendas(capasConfig, capasWMS) {
          const legendsContent = document.querySelector('.map-legends-content');
          if (!legendsContent) return;

          legendsContent.innerHTML = '';
          let capasActivas = 0;
          const simbologias = storyMapConfig.simbologias || {};

          capasConfig.forEach((capaConfig, index) => {
            if (capaConfig.tipo !== 'wms' || capaConfig.leyenda === false) return;
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) return;

            const capa = capasWMS[index];
            if (capa && capa.getVisible()) {
              capasActivas++;

              const legendItem = document.createElement('div');
              legendItem.className = 'legend-item';

              const legendTitle = document.createElement('div');
              legendTitle.className = 'legend-item-title';
              legendTitle.textContent = capaConfig.nombre;
              legendItem.appendChild(legendTitle);

              // Verificar si hay simbolog√≠a manual definida
              const simbologia = simbologias[capaConfig.layer];
              if (simbologia) {
                // Usar simbolog√≠a manual
                const simbologiaContainer = document.createElement('div');
                simbologiaContainer.innerHTML = generarSimbologiaHTML(simbologia);
                legendItem.appendChild(simbologiaContainer.firstElementChild);
              } else {
                // Usar imagen de GeoServer como fallback
                const legendImage = document.createElement('img');
                legendImage.className = 'legend-item-image';

                let legendUrl;
                const legendParams = `REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${capaConfig.layer}&WIDTH=15&HEIGHT=15&LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:11;dpi:96;forceLabels:on;fontName:Sans-Serif`;

                if (isVercelProxy) {
                  const legendPath = `/geoserver/SEICCT/wms?${legendParams}`;
                  const encodedLegendPath = encodeURIComponent(legendPath);
                  legendUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedLegendPath}`;
                } else {
                  legendUrl = `${proxyUrl}/SEICCT/wms?${legendParams}`;
                }

                legendImage.src = legendUrl;
                legendImage.alt = `Leyenda de ${capaConfig.nombre}`;
                legendItem.appendChild(legendImage);
              }

              legendsContent.appendChild(legendItem);
            }
          });

          if (capasActivas === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'map-legends-empty';
            emptyMessage.textContent = 'No hay capas activas';
            legendsContent.appendChild(emptyMessage);
          }
        }

        // ============================================================
        // CAP√çTULO 2 - GR√ÅFICAS DE AN√ÅLISIS DE AMENAZAS
        // ============================================================

        // Gr√°fica 2-1: Frecuencia de Eventos (Gr√°fica 75)
        const ctx21 = document.getElementById('chart-2-1');
        if (ctx21) {
          // Datos de la gr√°fica 75
          const eventosLabels = [
            'Sequ√≠a', 'Granizada', 'Nevada', 'Incendio', 'Helada',
            'Lluvia intensa', 'Plaga', 'Desbordamiento', 'Inundaci√≥n',
            'Desbordamiento', 'Olas de calor', 'Hurac√°n', 'Lluvia intensa',
            'Sismo', 'Desecaci√≥n', 'Tala inmoderada', 'Tornado', 'Sequ√≠a-Helada'
          ];
          const eventosData = [32, 14, 7, 7, 7, 6, 6, 4, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1];

          new Chart(ctx21.getContext('2d'), {
            type: 'bar',
            data: {
              labels: eventosLabels,
              datasets: [{
                label: 'Frecuencia',
                data: eventosData,
                backgroundColor: '#8B1A4A',
                borderColor: '#8B1A4A',
                borderWidth: 1,
                barPercentage: 0.8,
                categoryPercentage: 0.9
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'x',
              plugins: {
                title: {
                  display: false
                },
                legend: {
                  display: false
                },
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'top',
                  color: '#333',
                  font: {
                    weight: 'bold',
                    size: 10
                  },
                  formatter: function(value) {
                    return value;
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Frecuencia: ' + context.parsed.y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    font: {
                      size: 9
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  max: 35,
                  ticks: {
                    stepSize: 5
                  },
                  grid: {
                    display: true,
                    color: '#e0e0e0'
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }

        // Gr√°fica 2-2: Frecuencia de menci√≥n de riesgos por municipio (Gr√°fica 77)
        const ctx22 = document.getElementById('chart-2-2');
        if (ctx22) {
          // Datos de la gr√°fica 77
          const municipiosLabels = [
            'Tlaxco', 'Huamantla', 'Tlaxcala', 'Tetla de la Solidaridad', 'Terrenate',
            'Apizaco', 'Calpulalpan', 'Teolocholco', 'Ixtacuixtla', 'Nanacamilpa',
            'San Francisco Tetlanohcan', 'Atlangatepec', 'Atlzayanca', 'Sanct√≥rum',
            'Emiliano Zapata', 'Cuapiaxtla', 'Tepetitla', 'San Jos√© Teacalco',
            'Espa√±ita', 'Ixtenco', 'Acuamanala', 'Panotla', 'San Pablo del Monte',
            'Totolac', 'El Carmen Tequexquitla', 'Chiautempan', 'Nativitas', 'Tepeyanco',
            'Ziltlalt√©pec', 'Tzompantepec', 'Xicohtzinco', 'L√°zaro C√°rdenas',
            'Apetatitl√°n', 'Xaloztoc', 'Papalotla', 'Santa Cruz Quilehtla',
            'Mu√±oz de Domingo Arenas', 'Mazatecochco', 'Contla', 'Santa Cruz Tlaxcala',
            'Santa Ana Nopalucan', 'Tenancingo', 'Tetlatlahuca', 'Yauhquemehcan',
            'Zacatelco', 'Santa Catarina Ayometla'
          ];
          const municipiosData = [
            26, 17, 10, 10, 9, 8, 8, 8, 7, 7, 7, 6, 6, 6, 5, 5, 5, 5,
            4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2,
            1, 1, 1, 1, 1, 1, 1, 1
          ];

          new Chart(ctx22.getContext('2d'), {
            type: 'bar',
            data: {
              labels: municipiosLabels,
              datasets: [{
                label: 'Frecuencia',
                data: municipiosData,
                backgroundColor: '#8B1A4A',
                borderColor: '#8B1A4A',
                borderWidth: 1,
                barPercentage: 0.85,
                categoryPercentage: 0.9
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'x',
              plugins: {
                title: {
                  display: false
                },
                legend: {
                  display: false
                },
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'top',
                  color: '#333',
                  font: {
                    weight: 'bold',
                    size: 8
                  },
                  formatter: function(value) {
                    return value;
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Menciones: ' + context.parsed.y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    maxRotation: 90,
                    minRotation: 45,
                    font: {
                      size: 7
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  max: 30,
                  ticks: {
                    stepSize: 5
                  },
                  grid: {
                    display: true,
                    color: '#e0e0e0'
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }

        // ============================================================
        // CAP√çTULO 4 - GR√ÅFICA DE SEQU√çA (√Årea apilada)
        // ============================================================

        const ctx41 = document.getElementById('chart-4-1');
        if (ctx41) {
          // Fechas desde enero 2010 hasta enero 2023 (mensual simplificado a trimestral para mejor visualizaci√≥n)
          const fechasSequia = [
            '2010-01', '2010-04', '2010-07', '2010-10',
            '2011-01', '2011-04', '2011-07', '2011-10',
            '2012-01', '2012-04', '2012-07', '2012-10',
            '2013-01', '2013-04', '2013-07', '2013-10',
            '2014-01', '2014-04', '2014-07', '2014-10',
            '2015-01', '2015-04', '2015-07', '2015-10',
            '2016-01', '2016-04', '2016-07', '2016-10',
            '2017-01', '2017-04', '2017-07', '2017-10',
            '2018-01', '2018-04', '2018-07', '2018-10',
            '2019-01', '2019-04', '2019-07', '2019-10',
            '2020-01', '2020-04', '2020-07', '2020-10',
            '2021-01', '2021-04', '2021-07', '2021-10',
            '2022-01', '2022-04', '2022-07', '2022-10',
            '2023-01'
          ];

          // Datos aproximados basados en la gr√°fica 69
          // D0 Anormalmente seco (amarillo claro)
          const dataD0 = [
            18, 5, 0, 0, 60, 40, 0, 0, 0, 0, 0, 0,
            56, 35, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0,
            0, 5, 0, 0, 48, 42, 28, 15, 8, 12, 25, 30,
            28, 35, 40, 18, 60, 45, 30, 20, 55, 40, 25, 15,
            14, 18, 20, 15, 10
          ];

          // D1 Sequ√≠a Moderada (amarillo/naranja claro)
          const dataD1 = [
            0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0,
            0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 5, 12, 8, 5, 3, 5, 8,
            2, 5, 3, 10, 0, 10, 15, 10, 0, 8, 12, 8,
            5, 8, 10, 8, 5
          ];

          // D2 Sequ√≠a Severa (naranja)
          const dataD2 = [
            0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0,
            0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 2, 5, 3, 0, 0, 1, 2,
            0, 1, 1, 3, 0, 3, 5, 5, 0, 2, 5, 3,
            0, 2, 3, 2, 0
          ];

          // D3 Sequ√≠a Extrema (rojo)
          const dataD3 = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,
            0, 0, 0, 1, 0, 0, 1, 2, 0, 0, 1, 1,
            0, 0, 0, 0, 0
          ];

          // D4 Sequ√≠a Excepcional (rojo oscuro)
          const dataD4 = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0
          ];

          new Chart(ctx41.getContext('2d'), {
            type: 'line',
            data: {
              labels: fechasSequia,
              datasets: [
                {
                  label: 'D0 Anormalmente seco',
                  data: dataD0,
                  backgroundColor: 'rgba(255, 255, 0, 0.7)',
                  borderColor: 'rgba(255, 255, 0, 1)',
                  borderWidth: 1,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                },
                {
                  label: 'D1 Sequ√≠a Moderada',
                  data: dataD1,
                  backgroundColor: 'rgba(255, 211, 127, 0.7)',
                  borderColor: 'rgba(255, 211, 127, 1)',
                  borderWidth: 1,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                },
                {
                  label: 'D2 Sequ√≠a Severa',
                  data: dataD2,
                  backgroundColor: 'rgba(230, 152, 0, 0.7)',
                  borderColor: 'rgba(230, 152, 0, 1)',
                  borderWidth: 1,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                },
                {
                  label: 'D3 Sequ√≠a Extrema',
                  data: dataD3,
                  backgroundColor: 'rgba(230, 0, 0, 0.7)',
                  borderColor: 'rgba(230, 0, 0, 1)',
                  borderWidth: 1,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                },
                {
                  label: 'D4 Sequ√≠a Excepcional',
                  data: dataD4,
                  backgroundColor: 'rgba(115, 0, 0, 0.7)',
                  borderColor: 'rgba(115, 0, 0, 1)',
                  borderWidth: 1,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                title: {
                  display: false
                },
                legend: {
                  display: true,
                  position: 'right',
                  labels: {
                    usePointStyle: true,
                    padding: 10,
                    font: { size: 10 }
                  }
                },
                datalabels: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Fecha',
                    font: { size: 11, weight: 'bold' }
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    font: { size: 8 },
                    callback: function(value, index) {
                      // Mostrar solo a√±os
                      const label = this.getLabelForValue(value);
                      if (label && label.endsWith('-01')) {
                        return label.substring(0, 4);
                      }
                      return '';
                    }
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  max: 70,
                  title: {
                    display: true,
                    text: 'Porcentaje del √°rea (%)',
                    font: { size: 11, weight: 'bold' }
                  },
                  ticks: {
                    stepSize: 10
                  },
                  grid: {
                    display: true,
                    color: '#e0e0e0'
                  }
                }
              }
            }
          });
        }

        // ============================================================
        // CAP√çTULO 3 - DISTRIBUCI√ìN ESPACIAL DE AMENAZAS
        // ============================================================
        const capitulo3 = storyMapConfig.capitulos[2]; 
        
        if (!capitulo3 || !capitulo3.mapa) {
          console.error('Cap√≠tulo 3 no encontrado o no tiene mapa');
        } else {
          
          const map3 = new ol.Map({
        target: 'map-3',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
            zIndex: 0, 
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(capitulo3.mapa.centro),
          zoom: capitulo3.mapa.zoom,
        }),
        controls: ol.control.defaults.defaults({
          zoom: true,
          attribution: false,
        }),
        });


        const capasWMS3 = [];


        capitulo3.mapa.capas.forEach((capaConfig, index) => {

        if (capaConfig.tipo === 'subtitulo') {
          capasWMS3.push(null);
          return;
        }

        if (capaConfig.tipo === 'wms') {
          const workspace = 'SEICCT';
          let wmsSource3;

          if (isVercelProxy) {
            // Para Vercel: usar tileLoadFunction personalizado
            const basePath3 = `/geoserver/${workspace}/wms`;
            wmsSource3 = new ol.source.TileWMS({
              url: proxyUrl.replace('?path=', ''),
              params: {
                'LAYERS': capaConfig.layer,
                'TILED': true,
                'VERSION': '1.1.0',
                'FORMAT': 'image/png',
                'TRANSPARENT': true,
              },
              serverType: 'geoserver',
              crossOrigin: 'anonymous',
              tileLoadFunction: function(imageTile, src) {
                const url = new URL(src, window.location.origin);
                const params = url.searchParams.toString();
                const fullPath = `${basePath3}?${params}`;
                const encodedPath = encodeURIComponent(fullPath);
                const finalUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                imageTile.getImage().src = finalUrl;
              },
            });
          } else {
            // Para local: URL directa
            wmsSource3 = new ol.source.TileWMS({
              url: proxyUrl + '/SEICCT/wms',
              params: {
                'LAYERS': capaConfig.layer,
                'TILED': true,
              },
              serverType: 'geoserver',
            });
          }

          const wmsLayer = new ol.layer.Tile({
            source: wmsSource3,
            visible: capaConfig.visible || false,
            opacity: capaConfig.opacity || 1,
            zIndex: capaConfig.zIndex || index,
          });
          wmsLayer.set('name', capaConfig.nombre);
          map3.addLayer(wmsLayer);
          capasWMS3.push(wmsLayer);
        }


        if (capaConfig.tipo === 'wfs') {
          const typeName = capaConfig.layers;
          const layerParts = typeName.split(':');
          const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

          const vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
              const params = new URLSearchParams({
                service: 'WFS',
                version: '1.0.0',
                request: 'GetFeature',
                typeName: typeName,
                outputFormat: 'application/json',
                srsname: 'EPSG:3857',
                bbox: `${extent.join(',')},EPSG:3857`
              });

              if (isVercelProxy) {
                // Para Vercel: URL-encode el path completo
                const wfsPath = `/geoserver/${workspace}/ows?${params.toString()}`;
                const encodedPath = encodeURIComponent(wfsPath);
                return `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
              } else {
                // Para local
                return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
              }
            },
            strategy: ol.loadingstrategy.bbox
          });

          
          const transparentStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'rgba(0, 0, 0, 0)',
              width: 0
            }),
            fill: new ol.style.Fill({
              color: 'rgba(0, 0, 0, 0)'
            })
          });

          const wfsLayer = new ol.layer.Vector({
            source: vectorSource,
            style: transparentStyle,
            visible: true,
            zIndex: 999
          });
          wfsLayer.set('name', capaConfig.nombre);
          wfsLayer.set('tipo', 'wfs');
          map3.addLayer(wfsLayer);

          
          configurarHoverMunicipios3(map3);

          capasWMS3.push(null); // Mantener √≠ndice
        }
        });

        
        generarControlesCapas3(capitulo3.mapa.capas, capasWMS3);

        /**
         * Configura hover para municipios en el mapa del cap√≠tulo 3
         * @param {ol.Map} mapa - Instancia del mapa de OpenLayers
         */
        function configurarHoverMunicipios3(mapa) {
          const mapElement = document.getElementById('map-3');
          if (!mapElement) return;

          // Crear tooltip si no existe
          let tooltip = mapElement.querySelector('.municipio-hover-tooltip');
          if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'municipio-hover-tooltip';
            tooltip.style.display = 'none';
            mapElement.appendChild(tooltip);
          }

          // Variable para rastrear feature actual
          let currentFeature3 = null;
          let defaultStyle3 = null;

          // Estilo de hover
          const hoverStyle3 = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: '#A21A5C',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'rgba(162, 26, 92, 0.2)'
            })
          });

          mapa.on('pointermove', (evt) => {
            const pixel = mapa.getEventPixel(evt.originalEvent);

            // Restaurar estilo del feature anterior
            if (currentFeature3) {
              currentFeature3.setStyle(defaultStyle3);
              currentFeature3 = null;
              tooltip.style.display = 'none';
            }

            // Buscar feature bajo el cursor
            mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
              if (layer && layer.get('tipo') === 'wfs') {
                currentFeature3 = feature;
                defaultStyle3 = feature.getStyle() || layer.getStyle();

                // Aplicar estilo de hover
                feature.setStyle(hoverStyle3);

                // Obtener nombre del municipio
                const properties = feature.getProperties();
                const nombreMunicipio =
                  properties.Municipio ||
                  properties.MUNICIPIO ||
                  properties.municipio ||
                  properties.nombre ||
                  properties.NOMBRE ||
                  properties.NOM_MUN ||
                  properties.nom_mun ||
                  properties.NOMGEO ||
                  properties.nomgeo ||
                  'Municipio';

                // Mostrar tooltip
                tooltip.textContent = nombreMunicipio;
                tooltip.style.display = 'block';
                tooltip.style.left = `${evt.originalEvent.offsetX + 15}px`;
                tooltip.style.top = `${evt.originalEvent.offsetY + 15}px`;

                return true; // Detener b√∫squeda
              }
            });

            // Cambiar cursor
            mapa.getTargetElement().style.cursor = currentFeature3 ? 'pointer' : '';
          });
        }

        /**
         * Genera controles de capas para el mapa del cap√≠tulo 3
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function generarControlesCapas3(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-3');
          if (!mapContainer || !mapContainer.parentElement) return;

         
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

        
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

         
          capasConfig.forEach((capaConfig, index) => {
           
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

           
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

           
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-3-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

          
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                
                actualizarPanelLeyendas3(capasConfig, capasWMS);
              });
            }
          });

          
          crearPanelLeyendas3(mapContainer.parentElement);
         
          actualizarPanelLeyendas3(capasConfig, capasWMS);
        }

        /**
         * Crea panel de leyendas para el mapa del cap√≠tulo 3
         * @param {HTMLElement} mapParent - Elemento padre
         */
        function crearPanelLeyendas3(mapParent) {
        let legendsContainer = mapParent.querySelector('.map-legends');
        if (legendsContainer) return; 

        legendsContainer = document.createElement('div');
        legendsContainer.className = 'map-legends';
        mapParent.appendChild(legendsContainer);

        legendsContainer.innerHTML = `
          <div class="map-legends-header">
            <div class="map-legends-title">Leyendas</div>
            <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
          </div>
          <div class="map-legends-content"></div>
        `;

        const toggleButton = legendsContainer.querySelector('.map-legends-toggle');
        toggleButton.addEventListener('click', () => {
          legendsContainer.classList.toggle('collapsed');
          toggleButton.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        });
        }

        /**
         * Actualiza panel de leyendas del cap√≠tulo 3
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function actualizarPanelLeyendas3(capasConfig, capasWMS) {
        const mapContainer = document.getElementById('map-3');
        if (!mapContainer || !mapContainer.parentElement) return;

        const legendsContainer = mapContainer.parentElement.querySelector('.map-legends');
        if (!legendsContainer) return;

        const legendsContent = legendsContainer.querySelector('.map-legends-content');
        legendsContent.innerHTML = '';

        let capasActivas = 0;
        const simbologias = storyMapConfig.simbologias || {};

        capasConfig.forEach((capaConfig, index) => {
          if (capaConfig.tipo !== 'wms' || !capaConfig.leyenda) return;

          const capa = capasWMS[index];
          if (capa && capa.getVisible()) {
            capasActivas++;

            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const legendTitle = document.createElement('div');
            legendTitle.className = 'legend-item-title';
            legendTitle.textContent = capaConfig.nombre;
            legendItem.appendChild(legendTitle);

            // Verificar si hay simbolog√≠a manual definida
            const simbologia = simbologias[capaConfig.layer];
            if (simbologia) {
              // Usar simbolog√≠a manual
              const simbologiaContainer = document.createElement('div');
              simbologiaContainer.innerHTML = generarSimbologiaHTML(simbologia);
              legendItem.appendChild(simbologiaContainer.firstElementChild);
            } else {
              // Usar imagen de GeoServer como fallback
              const legendImage = document.createElement('img');
              legendImage.className = 'legend-item-image';

              let legendUrl3;
              const legendParams3 = `REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${capaConfig.layer}&WIDTH=15&HEIGHT=15&LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:11;dpi:96;forceLabels:on;fontName:Sans-Serif`;

              if (isVercelProxy) {
                const legendPath3 = `/geoserver/SEICCT/wms?${legendParams3}`;
                const encodedLegendPath3 = encodeURIComponent(legendPath3);
                legendUrl3 = `${proxyUrl.replace('?path=', '')}?path=${encodedLegendPath3}`;
              } else {
                legendUrl3 = `${proxyUrl}/SEICCT/wms?${legendParams3}`;
              }

              legendImage.src = legendUrl3;
              legendImage.alt = `Leyenda de ${capaConfig.nombre}`;
              legendItem.appendChild(legendImage);
            }

            legendsContent.appendChild(legendItem);
          }
        });


        if (capasActivas === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'map-legends-empty';
          emptyMessage.textContent = 'No hay capas activas';
          legendsContent.appendChild(emptyMessage);
        }
        }
        }

        // ============================================================
        // CAP√çTULO 5 - GR√ÅFICA DE HELADAS (FD0)
        // ============================================================

        const ctx51 = document.getElementById('chart-5-1');
        if (ctx51) {
          // A√±os desde 1975 hasta 2020
          const aniosHeladas = [];
          for (let y = 1975; y <= 2020; y++) {
            aniosHeladas.push(y);
          }

          // Datos de n√∫mero de d√≠as de heladas (FD0) - Gr√°fica 72
          const diasHeladas = [
            33, 42, 22, 17, 22, 30, 19, 23, 30, 24, 24, 40, 43, 22, 22,  // 1975-1989
            9, 11, 22, 19, 15, 30, 18, 31, 38, 46, 37, 28, 25, 28, 26,   // 1990-2004
            26, 28, 21, 27, 25, 36, 21, 36, 25, 13, 6, 9, 22, 17, 25, 21 // 2005-2020
          ];

          new Chart(ctx51.getContext('2d'), {
            type: 'bar',
            data: {
              labels: aniosHeladas,
              datasets: [{
                label: 'D√≠as de heladas',
                data: diasHeladas,
                backgroundColor: '#6B8E23',
                borderColor: '#556B2F',
                borderWidth: 1,
                barPercentage: 0.85,
                categoryPercentage: 0.9
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: false
                },
                legend: {
                  display: false
                },
                datalabels: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'D√≠as de heladas: ' + context.parsed.y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: false
                  },
                  ticks: {
                    maxRotation: 90,
                    minRotation: 90,
                    autoSkip: false,
                    font: { size: 8 }
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  max: 50,
                  title: {
                    display: true,
                    text: 'N√∫mero de d√≠as',
                    font: { size: 11, weight: 'bold' }
                  },
                  ticks: {
                    stepSize: 5
                  },
                  grid: {
                    display: true,
                    color: '#e0e0e0'
                  }
                }
              }
            }
          });
        }

        // ============================================================
        // CAP√çTULO 5 - MAPA DE HELADAS
        // ============================================================
        const map5 = new ol.Map({
          target: 'map-5',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
              zIndex: 0,
            }),
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([-98.16560203447955, 19.42964878131165]),
            zoom: 9.5,
          }),
          controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: false,
            rotate: false,
          }),
        });

        // Agregar capa WMS de Heladas
        let heladasSource;
        const workspace5 = 'SEICCT';

        if (isVercelProxy) {
          // Para Vercel: usar tileLoadFunction personalizado
          const basePath5 = `/geoserver/${workspace5}/wms`;
          heladasSource = new ol.source.TileWMS({
            url: proxyUrl.replace('?path=', ''),
            params: {
              'LAYERS': 'SEICCT:heladas',
              'TILED': true,
              'VERSION': '1.1.0',
              'FORMAT': 'image/png',
              'TRANSPARENT': true,
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous',
            tileLoadFunction: function(imageTile, src) {
              const url = new URL(src, window.location.origin);
              const params = url.searchParams.toString();
              const fullPath = `${basePath5}?${params}`;
              const encodedPath = encodeURIComponent(fullPath);
              const finalUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
              imageTile.getImage().src = finalUrl;
            },
          });
        } else {
          // Para local: URL directa
          heladasSource = new ol.source.TileWMS({
            url: proxyUrl + '/SEICCT/wms',
            params: {
              'LAYERS': 'SEICCT:heladas',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true,
            },
            serverType: 'geoserver',
          });
        }

        const heladasLayer = new ol.layer.Tile({
          source: heladasSource,
          opacity: 1,
          zIndex: 1,
          visible: true,
        });
        heladasLayer.set('name', 'Heladas');

        map5.addLayer(heladasLayer);

        // Configuraci√≥n de capas para el mapa 5
        const capasConfigMap5 = [
          {
            nombre: "Heladas",
            tipo: "wms",
            layer: "SEICCT:heladas",
            visible: true,
            leyenda: true,
          }
        ];

        // Crear control de capas para map-5
        const mapContainer5 = document.getElementById('map-5');
        if (mapContainer5) {
          let controlsContainer5 = document.createElement('div');
          controlsContainer5.className = 'map-controls';
          controlsContainer5.id = 'map-controls-5';
          mapContainer5.appendChild(controlsContainer5);

          controlsContainer5.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

          const contentContainer5 = controlsContainer5.querySelector('.map-controls-content');
          const toggleBtn5 = controlsContainer5.querySelector('.map-controls-toggle');

          toggleBtn5.addEventListener('click', () => {
            controlsContainer5.classList.toggle('collapsed');
            toggleBtn5.textContent = controlsContainer5.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

          // Agregar checkbox para la capa de Heladas
          const layerControl5 = document.createElement('div');
          layerControl5.className = 'layer-control';
          layerControl5.innerHTML = `
            <input type="checkbox" id="layer-heladas-5" checked />
            <label for="layer-heladas-5">Heladas</label>
          `;
          contentContainer5.appendChild(layerControl5);

          const checkbox5 = layerControl5.querySelector('#layer-heladas-5');
          checkbox5.addEventListener('change', (e) => {
            heladasLayer.setVisible(e.target.checked);
          });
        }

        // ============================================================
        // NAVEGACI√ìN Y CONTROLES
        // ============================================================
        const navbarToggle = document.getElementById("navbarToggle");
        const navbarMenu = document.getElementById("navbarMenu");

        
        navbarToggle.addEventListener("click", () => {
          navbarToggle.classList.toggle("active");
          navbarMenu.classList.toggle("active");
        });

        
        const navbarLinks = document.querySelectorAll(".navbar-link");
        navbarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            navbarToggle.classList.remove("active");
            navbarMenu.classList.remove("active");
          });
        });

        
        const navbar = document.querySelector(".navbar");
        const navbarIndicator = document.getElementById("navbarIndicator");

        
        window.addEventListener("scroll", () => {
          if (window.scrollY > 50) {
            navbar.classList.add("scrolled");
          } else {
            navbar.classList.remove("scrolled");
          }
        });

  
        navbarIndicator.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

        
        navbar.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

       
        navbar.addEventListener("mouseleave", () => {
          navbar.classList.remove("visible");
        });

        
        navbarIndicator.addEventListener("click", () => {
          navbar.classList.toggle("visible");
        });

        // ============================================================
        // NAVEGACI√ìN ENTRE CAP√çTULOS
        // ============================================================
        const chaptersContainer = document.getElementById("chaptersContainer");
        const timelineItems = document.querySelectorAll(".timeline-item");
        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");

        let currentChapter = 1;
        const totalChapters = 5;

        /**
         * Navega a un cap√≠tulo espec√≠fico con scroll suave
         * @param {number} chapterNum - N√∫mero del cap√≠tulo (1-3)
         */
        function goToChapter(chapterNum) {

          if (chapterNum < 1 || chapterNum > totalChapters) {

            return;
          }

          currentChapter = chapterNum;

          
          timelineItems.forEach(item => {
            const itemChapter = parseInt(item.dataset.chapter);
            if (itemChapter === currentChapter) {
              item.classList.add("active");
            } else {
              item.classList.remove("active");
            }
          });

         
          const targetChapter = document.getElementById(`chapter-${chapterNum}`);
  
          if (targetChapter) {
            targetChapter.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            console.error(`No se encontr√≥ el elemento chapter-${chapterNum}`);
          }
        }

        
        timelineItems.forEach(item => {
          item.addEventListener("click", () => {
            const chapterNum = parseInt(item.dataset.chapter);

            goToChapter(chapterNum);
          });
        });



       
        btnPrev.addEventListener("click", () => {

          goToChapter(currentChapter - 1);
        });

        btnNext.addEventListener("click", () => {

          goToChapter(currentChapter + 1);
        });

        
        goToChapter(1);
      }); 
    </script>
  </body>
</html>
