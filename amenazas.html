<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Story Map sobre las Amenazas Clim√°ticas en Tlaxcala"
    />
    <title>Amenazas Clim√°ticas - Tlaxcala</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/story-map.css" />

    <!-- OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <!-- Papa Parse para CSVs -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <!--         <span class="navbar-brand-icon">&#127757;</span> -->
          <span>Tlaxcala</span>
        </a>

        <button class="navbar-toggle" id="navbarToggle" aria-label="Abrir men√∫">
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
        </button>

        <div class="navbar-menu" id="navbarMenu">
          <a href="index.html" class="navbar-link">Inicio</a>
          <a href="vulnerabilidad.html" class="navbar-link">Vulnerabilidad</a>
          <a href="riesgo.html" class="navbar-link">Riesgo</a>
          <a href="amenazas.html" class="navbar-link active">Amenazas</a>
          <a href="impactos.html" class="navbar-link">Impactos</a>
          <a href="acciones-climaticas.html" class="navbar-link">Acciones Clim√°ticas</a>
        </div>
      </div>
    </nav>

    <!-- Indicador para mostrar el navbar -->
    <div class="navbar-indicator" id="navbarIndicator"></div>

    <!-- Contenedor principal del Story Map -->
    <div class="story-map-container">
      <!-- Contenedor de cap√≠tulos con scroll-snap -->
      <div class="chapters-container" id="chaptersContainer">
        <!-- CAP√≠TULO 1 -->
        <section class="chapter" id="chapter-1" data-chapter="1">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Amenazas clim√°ticas por municipio</h2>

          <!-- Mapa -->
          <div class="chapter-map">
            <div class="map-container" id="map-1"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text">
            <!-- <span class="chapter-number">Cap√≠tulo 1</span> -->
            <h2 class="chapter-title">
              ¬øQu√© es una Amenaza?
            </h2>
            <div class="chapter-content">
              <p>
                Se refiere a cualquier evento o fen√≥meno que tiene el potencial de causar da√±o o perjuicio.
              </p>
              <p>
                Las amenazas pueden ser naturales, como huracanes, terremotos o inundaciones, o pueden ser antropog√©nicas, como la contaminaci√≥n o el conflicto armado. 
              </p>
              <p>
                En el contexto del cambio clim√°tico, las amenazas incluyen el aumento de la temperatura, el cambio en los patrones de precipitaci√≥n y la ocurrencia de fen√≥menos clim√°ticos extremos.
              </p>
            </div>
          </div>

<!-- Card combinada de gr√°fico e info (sin borde entre ellas) -->
<div class="chapter-chart-info">
  <!-- T√≠tulo √∫nico para toda la card -->
<!--   <h2 class="chart-info-title">Poblaci√≥n expuesta a amenazas clim√°ticas</h2> -->

  <div class="chart-info-content">
    <!-- Secci√≥n del gr√°fico -->
<!--     <div class="chart-section">
      <div class="chart-container">
        <canvas id="chart-1"></canvas>
      </div>
    </div> -->

    <!-- Secci√≥n de texto explicativo -->
<!--     <div class="info-section">
      <div class="info-content">
        <p>
          Las amenazas clim√°ticas son eventos hidrometeorol√≥gicos extremos que pueden impactar negativamente a la poblaci√≥n y al territorio. La identificaci√≥n y el an√°lisis de estas amenazas son fundamentales para la planificaci√≥n territorial y la gesti√≥n del riesgo. Para conocer a detalle las variables y su an√°lisis, te invitamos a consultar el PACCET 2023-2030.
        </p>
      </div>
    </div> -->
  </div>
</div>
        </section>

        <!-- CAP√çTULO 2 -->
        <section class="chapter chapter-analytics" id="chapter-2" data-chapter="2">
          <!-- T√≠tulo del cap√≠tulo -->
          <h2 class="map-title">An√°lisis de Amenazas Clim√°ticas</h2>

          <!-- Card de texto (izquierda, 30%) -->
          <div class="analytics-text">
            <h2 class="chapter-title">Tendencias y Patrones</h2>
            <br>
            <div class="chapter-content">
              <p>
                En los talleres de diagn√≥stico se identificaron las principales amenazas clim√°ticas que enfrenta Tlaxcala. 
              </p>
              <p>
                Estos fen√≥menos impactan la vida de las comunidades, la biodiversidad y la econom√≠a local.
              </p>
              <p>
                Conocerlos es el primer paso para dise√±ar estrategias de adaptaci√≥n y reducir los riesgos.
              </p>
            </div>
          </div>

          <!-- Card gr√°fica superior (derecha arriba, 70%) -->
          <div class="analytics-chart-1">
            <h3 class="chart-title">Frecuencia de Eventos que se han presentado en el estado de Tlaxcala</h3>
            <div class="chart-container">
              <canvas id="chart-2-1"></canvas>
            </div>
          </div>

          <!-- Card gr√°fica inferior (derecha abajo, 70%) -->
          <div class="analytics-chart-2">
            <h3 class="chart-title">Frecuencia de menci√≥n de riesgos identificados por municipio</h3>
            <div class="chart-container">
              <canvas id="chart-2-2"></canvas>
            </div>
          </div>
        </section>

        <!-- CAP√çTULO 3 -->
        <section class="chapter amenazas-chapter-3" id="chapter-3" data-chapter="3">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Distribuci√≥n espacial de amenazas clim√°ticas</h2>

          <!-- Mapa -->
          <div class="chapter-map amenazas-chapter-map">
            <div class="map-container" id="map-3"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text amenazas-chapter-text">
            <h2 class="chapter-title">Impacto Territorial</h2>
            <div class="chapter-content">
              <p>
               <ul>
                <li><strong>üåµ Sequ√≠a:</strong>Entre 2010 y 2023 prevalecieron condiciones de sequ√≠a "anormalmente seca" (D0), ligadas a la disminuci√≥n de lluvias en la regi√≥n. <br>üîóFuente: <a href="https://smn.conagua.gob.mx/es/climatologia/monitor-de-sequia/monitor-de-sequia-en-mexico" target="_blank">Monitor de sequ√≠as CONAGUA</a></li>
                <li><br></li>
                <li><strong>üî• Fuegos forestales:</strong>Registrados en distintas zonas del estado, con informaci√≥n detallada en el SNIF. <br>üîóFuente: <a href="https://snif.cnf.gob.mx/incendios/" target="_blank">Incendios forestales ‚Äì SNIF</a></li>
                <li><br></li>
                <li><strong>üåä Inundaciones:</strong>Identificadas como amenazas recurrentes en varios municipios. <br>üîóDatos disponibles en: <a href="http://www.atlasnacionalderiesgos.gob.mx/archivo/visor-capas.html" target="_blank">Atlas Nacional de Riesgos</a></li>
                <li><br></li>
                <li><strong>üå≤ Deforestaci√≥n:</strong>Vinculada a la p√©rdida de cobertura vegetal y al aumento de la vulnerabilidad del territorio. <br>üîóFuente: <a href="https://snmf.cnf.gob.mx/sistema-nacional-de-monitoreo-forestal-2/" target="_blank">Sistema Nacional de Monitoreo Forestal</a></li>
                <li><br></li>
                <li><strong>üè≠ Emisi√≥n de contaminantes:</strong>Mencionada como amenaza, pero se recomienda moverla a la secci√≥n de Mitigaci√≥n por su relaci√≥n con reducci√≥n de emisiones y calidad del aire. <br>üîóFuente: <a href="https://gisviewer.semarnat.gob.mx/wmaplicacion/inem/" target="_blank">Inventario Nacional de Emisiones - SEMARNAT</a></li>
               </ul>
              </p>
            </div>
          </div>
        </section>
      </div>

      <!-- Timeline inferior -->
      <div class="timeline" id="timeline">
        <div class="timeline-item" data-chapter="1">
          <div class="timeline-circle">1</div>
          <div class="timeline-label">Amenazas clim√°ticas</div>
        </div>
        <div class="timeline-item" data-chapter="2">
          <div class="timeline-circle">2</div>
          <div class="timeline-label">An√°lisis y Tendencias</div>
        </div>
        <div class="timeline-item" data-chapter="3">
          <div class="timeline-circle">3</div>
          <div class="timeline-label">Impacto Territorial</div>
        </div>
      </div>

      <!-- Botones de navegaci√≥n -->
      <div class="nav-buttons left" id="navButtonsLeft">
        <button class="nav-btn" id="btnPrev" aria-label="Cap√≠tulo anterior">
          ‚Üê
        </button>
      </div>
      <div class="nav-buttons right" id="navButtonsRight">
        <button class="nav-btn" id="btnNext" aria-label="Siguiente cap√≠tulo">
          ‚Üí
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
      import { storyMapConfig } from './js/config/amenazas-config.js';

      // Esperar a que el DOM est√© listo
      window.addEventListener('DOMContentLoaded', () => {
        // ===== INICIALIZACI√ìN DEL MAPA =====
        const capituloActual = storyMapConfig.capitulos[0]; // Cap√≠tulo 1
        const proxyUrl = storyMapConfig.proxyUrl;

        // Crear el mapa
        const map = new ol.Map({
          target: 'map-1',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
              zIndex: 0, // Mapa base siempre debajo
            }),
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat(capituloActual.mapa.centro),
            zoom: capituloActual.mapa.zoom,
          }),
          controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: false,
          }),
        });

        // Array para guardar referencias a las capas
        const capasWMS = [];

        // Agregar capas WMS
        capituloActual.mapa.capas.forEach((capaConfig, index) => {
          // Saltar subt√≠tulos
          if (capaConfig.tipo === 'subtitulo') {
            capasWMS.push(null); // Mantener √≠ndice sincronizado
            return;
          }

          if (capaConfig.tipo === 'wms') {
            const wmsLayer = new ol.layer.Tile({
              source: new ol.source.TileWMS({
                url: proxyUrl + '/SEICCT/ows',
                params: {
                  'LAYERS': capaConfig.layer,
                  'TILED': true,
                },
                serverType: 'geoserver',
              }),
              visible: capaConfig.visible || false, // Usar visible de config o false
              opacity: capaConfig.opacity || 1,
              zIndex: capaConfig.zIndex || index,
            });
            wmsLayer.set('name', capaConfig.nombre);
            map.addLayer(wmsLayer);
            capasWMS.push(wmsLayer);
          }

          // Cargar capa WFS para interacci√≥n (hover)
          if (capaConfig.tipo === 'wfs') {
            const typeName = capaConfig.layers;
            const layerParts = typeName.split(':');
            const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

            const vectorSource = new ol.source.Vector({
              format: new ol.format.GeoJSON(),
              url: function(extent) {
                const params = new URLSearchParams({
                  service: 'WFS',
                  version: '1.0.0',
                  request: 'GetFeature',
                  typeName: typeName,
                  outputFormat: 'application/json',
                  srsname: 'EPSG:3857',
                  bbox: `${extent.join(',')},EPSG:3857`
                });
                return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
              },
              strategy: ol.loadingstrategy.bbox
            });

            // Estilo transparente para la capa de interacci√≥n
            const transparentStyle = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 0, 0)',
                width: 0
              }),
              fill: new ol.style.Fill({
                color: 'rgba(0, 0, 0, 0)'
              })
            });

            const wfsLayer = new ol.layer.Vector({
              source: vectorSource,
              style: transparentStyle,
              visible: true,
              zIndex: 999
            });
            wfsLayer.set('name', capaConfig.nombre);
            wfsLayer.set('tipo', 'wfs');
            map.addLayer(wfsLayer);

            // Configurar hover despu√©s de agregar la capa WFS
            configurarHoverMunicipios(map);

            capasWMS.push(null); // Mantener √≠ndice
          }
        });

        // ===== GENERAR CONTROLES DE CAPAS =====
        generarControlesCapas(capituloActual.mapa.capas, capasWMS);

        // ===== CONFIGURAR HOVER DE MUNICIPIOS =====
        function configurarHoverMunicipios(mapa) {
          const mapElement = document.getElementById('map-1');
          if (!mapElement) return;

          // Crear tooltip
          const tooltip = document.createElement('div');
          tooltip.className = 'municipio-hover-tooltip';
          tooltip.style.display = 'none';
          mapElement.appendChild(tooltip);

          // Variable para almacenar el feature actualmente resaltado
          let currentFeature = null;
          let defaultStyle = null;

          // Estilo de hover
          const hoverStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: '#A21A5C',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'rgba(162, 26, 92, 0.2)'
            })
          });

          // Listener de movimiento del mouse
          mapa.on('pointermove', (evt) => {
            const pixel = mapa.getEventPixel(evt.originalEvent);

            // Restaurar estilo del feature anterior
            if (currentFeature) {
              currentFeature.setStyle(defaultStyle);
              currentFeature = null;
              tooltip.style.display = 'none';
            }

            // Buscar feature bajo el cursor (solo capas WFS)
            mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
              if (layer && layer.get('tipo') === 'wfs') {
                currentFeature = feature;
                defaultStyle = feature.getStyle() || layer.getStyle();

                // Aplicar estilo de hover
                feature.setStyle(hoverStyle);

                // Obtener nombre del municipio
                const properties = feature.getProperties();
                const nombreMunicipio =
                  properties.Municipio ||
                  properties.MUNICIPIO ||
                  properties.municipio ||
                  properties.nombre ||
                  properties.NOMBRE ||
                  properties.NOM_MUN ||
                  properties.nom_mun ||
                  properties.NOMGEO ||
                  properties.nomgeo ||
                  'Municipio';

                // Actualizar tooltip
                tooltip.textContent = nombreMunicipio;
                tooltip.style.display = 'block';
                tooltip.style.left = `${evt.originalEvent.offsetX + 15}px`;
                tooltip.style.top = `${evt.originalEvent.offsetY + 15}px`;

                return true; // Detener b√∫squeda
              }
            });
          });
        }

        function generarControlesCapas(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-1');
          if (!mapContainer || !mapContainer.parentElement) return;

          // Buscar o crear el contenedor de controles
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          // Header con t√≠tulo y bot√≥n toggle
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

          // Contenedor para las capas
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          // Evento del bot√≥n toggle
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

          // Generar controles para cada capa
          capasConfig.forEach((capaConfig, index) => {
            // Si es un subt√≠tulo, crear un encabezado de grupo
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

            // No mostrar capas de interacci√≥n
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

            // Solo mostrar capas con leyenda: true
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

            // Evento del checkbox
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                // Actualizar panel de leyendas
                actualizarPanelLeyendas(capasConfig, capasWMS);
              });
            }
          });

          // Crear panel de leyendas
          crearPanelLeyendas(mapContainer.parentElement);
          // Actualizar panel de leyendas inicialmente
          actualizarPanelLeyendas(capasConfig, capasWMS);
        }

        // ===== CREAR PANEL DE LEYENDAS =====
        function crearPanelLeyendas(mapParent) {
          let legendsContainer = mapParent.querySelector('.map-legends');
          if (!legendsContainer) {
            legendsContainer = document.createElement('div');
            legendsContainer.className = 'map-legends';
            legendsContainer.innerHTML = `
              <div class="map-legends-header">
                <div class="map-legends-title">Leyendas</div>
                <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
              </div>
              <div class="map-legends-content"></div>
            `;
            mapParent.appendChild(legendsContainer);

            // Evento del bot√≥n toggle
            const toggleBtn = legendsContainer.querySelector('.map-legends-toggle');
            toggleBtn.addEventListener('click', () => {
              legendsContainer.classList.toggle('collapsed');
              toggleBtn.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            });
          }
        }

        // ===== ACTUALIZAR PANEL DE LEYENDAS =====
        function actualizarPanelLeyendas(capasConfig, capasWMS) {
          const legendsContent = document.querySelector('.map-legends-content');
          if (!legendsContent) return;

          // Limpiar contenido actual
          legendsContent.innerHTML = '';

          // Contar capas activas
          let capasActivas = 0;

          // Agregar leyendas de capas activas
          capasConfig.forEach((capaConfig, index) => {
            // Solo procesar capas WMS con leyenda
            if (capaConfig.tipo !== 'wms' || capaConfig.leyenda === false) return;
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) return;

            // Verificar si la capa est√° visible
            const capa = capasWMS[index];
            if (capa && capa.getVisible()) {
              capasActivas++;

              // Crear item de leyenda
              const legendItem = document.createElement('div');
              legendItem.className = 'legend-item';

              const legendTitle = document.createElement('div');
              legendTitle.className = 'legend-item-title';
              legendTitle.textContent = capaConfig.nombre;

              const legendImage = document.createElement('img');
              legendImage.className = 'legend-item-image';

              // URL de GetLegendGraphic de GeoServer
              const legendUrl = `${proxyUrl}/SEICCT/wms?` +
                `REQUEST=GetLegendGraphic&` +
                `VERSION=1.0.0&` +
                `FORMAT=image/png&` +
                `LAYER=${capaConfig.layer}&` +
                `WIDTH=20&` +
                `HEIGHT=20&` +
                `LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:10;dpi:72;forceLabels:on`;

              legendImage.src = legendUrl;
              legendImage.alt = `Leyenda de ${capaConfig.nombre}`;

              legendItem.appendChild(legendTitle);
              legendItem.appendChild(legendImage);
              legendsContent.appendChild(legendItem);
            }
          });

          // Mostrar mensaje si no hay capas activas
          if (capasActivas === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'map-legends-empty';
            emptyMessage.textContent = 'No hay capas activas';
            legendsContent.appendChild(emptyMessage);
          }
        }

        // ===== INICIALIZACI√ìN DEL MAPA CAP√çTULO 3 =====
        console.log('Total de cap√≠tulos en config:', storyMapConfig.capitulos.length);
        console.log('Cap√≠tulos:', storyMapConfig.capitulos);
        const capitulo3 = storyMapConfig.capitulos[2]; // Cap√≠tulo 3
        console.log('Capitulo 3:', capitulo3);

        if (!capitulo3 || !capitulo3.mapa) {
          console.error('Cap√≠tulo 3 no encontrado o no tiene mapa');
        } else {
          // Crear el mapa para cap√≠tulo 3
          const map3 = new ol.Map({
        target: 'map-3',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
            zIndex: 0, // Mapa base siempre debajo
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(capitulo3.mapa.centro),
          zoom: capitulo3.mapa.zoom,
        }),
        controls: ol.control.defaults.defaults({
          zoom: true,
          attribution: false,
        }),
        });

        // Array para guardar referencias a las capas del cap√≠tulo 3
        const capasWMS3 = [];

        // Agregar capas WMS al mapa 3
        capitulo3.mapa.capas.forEach((capaConfig, index) => {
        // Saltar subt√≠tulos
        if (capaConfig.tipo === 'subtitulo') {
          capasWMS3.push(null); // Mantener √≠ndice sincronizado
          return;
        }

        if (capaConfig.tipo === 'wms') {
          const wmsLayer = new ol.layer.Tile({
            source: new ol.source.TileWMS({
              url: proxyUrl + '/SEICCT/ows',
              params: {
                'LAYERS': capaConfig.layer,
                'TILED': true,
              },
              serverType: 'geoserver',
            }),
            visible: capaConfig.visible || false,
            opacity: capaConfig.opacity || 1,
            zIndex: capaConfig.zIndex || index,
          });
          wmsLayer.set('name', capaConfig.nombre);
          map3.addLayer(wmsLayer);
          capasWMS3.push(wmsLayer);
        }

        // Cargar capa WFS para interacci√≥n (hover) en mapa 3
        if (capaConfig.tipo === 'wfs') {
          const typeName = capaConfig.layers;
          const layerParts = typeName.split(':');
          const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

          const vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
              const params = new URLSearchParams({
                service: 'WFS',
                version: '1.0.0',
                request: 'GetFeature',
                typeName: typeName,
                outputFormat: 'application/json',
                srsname: 'EPSG:3857',
                bbox: `${extent.join(',')},EPSG:3857`
              });
              return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
            },
            strategy: ol.loadingstrategy.bbox
          });

          // Estilo transparente para la capa de interacci√≥n
          const transparentStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'rgba(0, 0, 0, 0)',
              width: 0
            }),
            fill: new ol.style.Fill({
              color: 'rgba(0, 0, 0, 0)'
            })
          });

          const wfsLayer = new ol.layer.Vector({
            source: vectorSource,
            style: transparentStyle,
            visible: true,
            zIndex: 999
          });
          wfsLayer.set('name', capaConfig.nombre);
          wfsLayer.set('tipo', 'wfs');
          map3.addLayer(wfsLayer);

          // Configurar hover para mapa 3
          configurarHoverMunicipios3(map3);

          capasWMS3.push(null); // Mantener √≠ndice
        }
        });

        // ===== GENERAR CONTROLES DE CAPAS PARA MAPA 3 =====
        generarControlesCapas3(capitulo3.mapa.capas, capasWMS3);

        // ===== CONFIGURAR HOVER DE MUNICIPIOS PARA MAPA 3 =====
        function configurarHoverMunicipios3(mapa) {
        const mapElement = document.getElementById('map-3');
        if (!mapElement) return;

        // Crear tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'municipio-hover-tooltip';
        tooltip.style.display = 'none';
        mapElement.appendChild(tooltip);

        // Hover sobre features
        mapa.on('pointermove', (event) => {
          const pixel = mapa.getEventPixel(event.originalEvent);
          let featureDetected = false;

          mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
            if (layer && layer.get('tipo') === 'wfs') {
              const municipio = feature.get('municipio') || feature.get('MUNICIPIO') || feature.get('Municipio');
              if (municipio) {
                tooltip.textContent = municipio;
                tooltip.style.display = 'block';
                tooltip.style.left = event.pixel[0] + 15 + 'px';
                tooltip.style.top = event.pixel[1] + 15 + 'px';
                featureDetected = true;
              }
            }
          });

          if (!featureDetected) {
            tooltip.style.display = 'none';
          }

          mapa.getTargetElement().style.cursor = featureDetected ? 'pointer' : '';
        });
        }

        // ===== FUNCI√ìN PARA GENERAR CONTROLES DE CAPAS MAPA 3 =====
        function generarControlesCapas3(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-3');
          if (!mapContainer || !mapContainer.parentElement) return;

          // Buscar o crear el contenedor de controles
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          // Header con t√≠tulo y bot√≥n toggle
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

          // Contenedor para las capas
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          // Evento del bot√≥n toggle
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

          // Generar controles para cada capa
          capasConfig.forEach((capaConfig, index) => {
            // Si es un subt√≠tulo, crear un encabezado de grupo
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

            // No mostrar capas de interacci√≥n
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

            // Solo mostrar capas con leyenda: true
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-3-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

            // Evento del checkbox
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                // Actualizar panel de leyendas
                actualizarPanelLeyendas3(capasConfig, capasWMS);
              });
            }
          });

          // Crear panel de leyendas
          crearPanelLeyendas3(mapContainer.parentElement);
          // Actualizar panel de leyendas inicialmente
          actualizarPanelLeyendas3(capasConfig, capasWMS);
        }

        // ===== FUNCI√ìN PARA CREAR PANEL DE LEYENDAS MAPA 3 =====
        function crearPanelLeyendas3(mapParent) {
        let legendsContainer = mapParent.querySelector('.map-legends');
        if (legendsContainer) return; // Ya existe

        legendsContainer = document.createElement('div');
        legendsContainer.className = 'map-legends';
        mapParent.appendChild(legendsContainer);

        legendsContainer.innerHTML = `
          <div class="map-legends-header">
            <div class="map-legends-title">Leyendas</div>
            <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
          </div>
          <div class="map-legends-content"></div>
        `;

        const toggleButton = legendsContainer.querySelector('.map-legends-toggle');
        toggleButton.addEventListener('click', () => {
          legendsContainer.classList.toggle('collapsed');
          toggleButton.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        });
        }

        // ===== FUNCI√ìN PARA ACTUALIZAR PANEL DE LEYENDAS MAPA 3 =====
        function actualizarPanelLeyendas3(capasConfig, capasWMS) {
        const mapParent = document.getElementById('map-3');
        if (!mapParent) return;

        const legendsContainer = mapParent.querySelector('.map-legends');
        if (!legendsContainer) return;

        const legendsContent = legendsContainer.querySelector('.map-legends-content');
        legendsContent.innerHTML = ''; // Limpiar contenido

        let capasActivas = 0;

        capasConfig.forEach((capaConfig, index) => {
          if (capaConfig.tipo !== 'wms' || !capaConfig.leyenda) return;

          const capa = capasWMS[index];
          if (capa && capa.getVisible()) {
            capasActivas++;

            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const legendTitle = document.createElement('div');
            legendTitle.className = 'legend-item-title';
            legendTitle.textContent = capaConfig.nombre;

            const legendImage = document.createElement('img');
            legendImage.className = 'legend-item-image';

            // URL de GetLegendGraphic de GeoServer
            const legendUrl = `${proxyUrl}/SEICCT/wms?` +
              `REQUEST=GetLegendGraphic&` +
              `VERSION=1.0.0&` +
              `FORMAT=image/png&` +
              `LAYER=${capaConfig.layer}&` +
              `WIDTH=20&HEIGHT=20&` +
              `LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:10;dpi:72;forceLabels:on`;

            legendImage.src = legendUrl;
            legendImage.alt = `Leyenda de ${capaConfig.nombre}`;

            legendItem.appendChild(legendTitle);
            legendItem.appendChild(legendImage);
            legendsContent.appendChild(legendItem);
          }
        });

        // Mostrar mensaje si no hay capas activas
        if (capasActivas === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'map-legends-empty';
          emptyMessage.textContent = 'No hay capas activas';
          legendsContent.appendChild(emptyMessage);
        }
        }
        } // Fin del if de verificaci√≥n de capitulo3

        // ===== NAVBAR =====
        const navbarToggle = document.getElementById("navbarToggle");
        const navbarMenu = document.getElementById("navbarMenu");

        // Toggle men√∫ m√≥vil
        navbarToggle.addEventListener("click", () => {
          navbarToggle.classList.toggle("active");
          navbarMenu.classList.toggle("active");
        });

        // Cerrar men√∫ al hacer click en un link
        const navbarLinks = document.querySelectorAll(".navbar-link");
        navbarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            navbarToggle.classList.remove("active");
            navbarMenu.classList.remove("active");
          });
        });

        // Navbar y navbar indicator
        const navbar = document.querySelector(".navbar");
        const navbarIndicator = document.getElementById("navbarIndicator");

        // Efecto scroll en navbar
        window.addEventListener("scroll", () => {
          if (window.scrollY > 50) {
            navbar.classList.add("scrolled");
          } else {
            navbar.classList.remove("scrolled");
          }
        });

        // Mostrar/ocultar navbar con el indicador

        // Mostrar navbar al hacer hover sobre el indicador
        navbarIndicator.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

        // Mantener navbar visible mientras el mouse est√° sobre √©l
        navbar.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

        // Ocultar navbar cuando el mouse sale
        navbar.addEventListener("mouseleave", () => {
          navbar.classList.remove("visible");
        });

        // Click en indicador para toggle del navbar
        navbarIndicator.addEventListener("click", () => {
          navbar.classList.toggle("visible");
        });

        // ===== NAVEGACI√ìN DE CAP√çTULOS =====
        const chaptersContainer = document.getElementById("chaptersContainer");
        const timelineItems = document.querySelectorAll(".timeline-item");
        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");

        console.log('Timeline items encontrados:', timelineItems.length);
        console.log('Chapters container:', chaptersContainer);

        let currentChapter = 1;
        const totalChapters = 3;

        // Funci√≥n para navegar a un cap√≠tulo
        function goToChapter(chapterNum) {
          console.log('goToChapter llamado con:', chapterNum);
          if (chapterNum < 1 || chapterNum > totalChapters) {
            console.log('N√∫mero de cap√≠tulo fuera de rango');
            return;
          }

          currentChapter = chapterNum;

          // Actualizar timeline activo
          timelineItems.forEach(item => {
            const itemChapter = parseInt(item.dataset.chapter);
            if (itemChapter === currentChapter) {
              item.classList.add("active");
            } else {
              item.classList.remove("active");
            }
          });

          // Scroll al cap√≠tulo
          const targetChapter = document.getElementById(`chapter-${chapterNum}`);
          console.log('Target chapter encontrado:', targetChapter);
          if (targetChapter) {
            targetChapter.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            console.error(`No se encontr√≥ el elemento chapter-${chapterNum}`);
          }
        }

        // Clicks en timeline
        timelineItems.forEach(item => {
          item.addEventListener("click", () => {
            const chapterNum = parseInt(item.dataset.chapter);
            console.log('Click en timeline item, cap√≠tulo:', chapterNum);
            goToChapter(chapterNum);
          });
        });

        console.log('Event listeners de timeline agregados');

        // Botones de navegaci√≥n
        btnPrev.addEventListener("click", () => {
          console.log('Click en bot√≥n anterior');
          goToChapter(currentChapter - 1);
        });

        btnNext.addEventListener("click", () => {
          console.log('Click en bot√≥n siguiente');
          goToChapter(currentChapter + 1);
        });

        // Marcar el cap√≠tulo 1 como activo al cargar
        goToChapter(1);
      }); // Fin DOMContentLoaded
    </script>
  </body>
</html>
