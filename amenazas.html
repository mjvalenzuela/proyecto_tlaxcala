<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Story Map sobre las Amenazas Clim√°ticas en Tlaxcala"
    />
    <title>Amenazas Clim√°ticas - Tlaxcala</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/story-map.css" />

    <!-- OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <!-- Papa Parse para CSVs -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <!--         <span class="navbar-brand-icon">&#127757;</span> -->
          <span>Tlaxcala</span>
        </a>

        <button class="navbar-toggle" id="navbarToggle" aria-label="Abrir men√∫">
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
        </button>

        <div class="navbar-menu" id="navbarMenu">
          <a href="index.html" class="navbar-link">Inicio</a>
          <a href="vulnerabilidad.html" class="navbar-link">Vulnerabilidad</a>
          <a href="riesgo.html" class="navbar-link">Riesgo</a>
          <a href="amenazas.html" class="navbar-link active">Amenazas</a>
          <a href="impactos.html" class="navbar-link">Impactos</a>
          <a href="acciones-climaticas.html" class="navbar-link">Acciones Clim√°ticas</a>
        </div>
      </div>
    </nav>

    <!-- Indicador para mostrar el navbar -->
    <div class="navbar-indicator" id="navbarIndicator"></div>

    <!-- Contenedor principal del Story Map -->
    <div class="story-map-container">
      <!-- Contenedor de cap√≠tulos con scroll-snap -->
      <div class="chapters-container" id="chaptersContainer">
        <!-- CAP√≠TULO 1 -->
        <section class="chapter" id="chapter-1" data-chapter="1">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Amenazas clim√°ticas por municipio</h2>

          <!-- Mapa -->
          <div class="chapter-map">
            <div class="map-container" id="map-1"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text">
            <!-- <span class="chapter-number">Cap√≠tulo 1</span> -->
            <h2 class="chapter-title">
              ¬øQu√© es una Amenaza?
            </h2>
            <div class="chapter-content">
              <p>
                Se refiere a cualquier evento o fen√≥meno que tiene el potencial de causar da√±o o perjuicio.
              </p>
              <p>
                Las amenazas pueden ser naturales, como huracanes, terremotos o inundaciones, o pueden ser antropog√©nicas, como la contaminaci√≥n o el conflicto armado. 
              </p>
              <p>
                En el contexto del cambio clim√°tico, las amenazas incluyen el aumento de la temperatura, el cambio en los patrones de precipitaci√≥n y la ocurrencia de fen√≥menos clim√°ticos extremos.
              </p>
            </div>
          </div>

<!-- Card combinada de gr√°fico e info (sin borde entre ellas) -->
<div class="chapter-chart-info">
  <!-- T√≠tulo √∫nico para toda la card -->
<!--   <h2 class="chart-info-title">Poblaci√≥n expuesta a amenazas clim√°ticas</h2> -->

  <div class="chart-info-content">
    <!-- Secci√≥n del gr√°fico -->
<!--     <div class="chart-section">
      <div class="chart-container">
        <canvas id="chart-1"></canvas>
      </div>
    </div> -->

    <!-- Secci√≥n de texto explicativo -->
<!--     <div class="info-section">
      <div class="info-content">
        <p>
          Las amenazas clim√°ticas son eventos hidrometeorol√≥gicos extremos que pueden impactar negativamente a la poblaci√≥n y al territorio. La identificaci√≥n y el an√°lisis de estas amenazas son fundamentales para la planificaci√≥n territorial y la gesti√≥n del riesgo. Para conocer a detalle las variables y su an√°lisis, te invitamos a consultar el PACCET 2023-2030.
        </p>
      </div>
    </div> -->
  </div>
</div>
        </section>

        <!-- CAP√çTULO 2 -->
        <section class="chapter chapter-analytics" id="chapter-2" data-chapter="2">
          <!-- T√≠tulo del cap√≠tulo -->
          <h2 class="map-title">An√°lisis de Amenazas Clim√°ticas</h2>

          <!-- Card de texto (izquierda, 30%) -->
          <div class="analytics-text">
            <h2 class="chapter-title">Tendencias y Patrones</h2>
            <br>
            <div class="chapter-content">
              <p>
                En los talleres de diagn√≥stico se identificaron las principales amenazas clim√°ticas que enfrenta Tlaxcala. 
              </p>
              <p>
                Estos fen√≥menos impactan la vida de las comunidades, la biodiversidad y la econom√≠a local.
              </p>
              <p>
                Conocerlos es el primer paso para dise√±ar estrategias de adaptaci√≥n y reducir los riesgos.
              </p>
            </div>
          </div>

          <!-- Card gr√°fica superior (derecha arriba, 70%) -->
          <div class="analytics-chart-1">
            <h3 class="chart-title">Frecuencia de Eventos que se han presentado en el estado de Tlaxcala</h3>
            <div class="chart-container">
              <canvas id="chart-2-1"></canvas>
            </div>
          </div>

          <!-- Card gr√°fica inferior (derecha abajo, 70%) -->
          <div class="analytics-chart-2">
            <h3 class="chart-title">Frecuencia de menci√≥n de riesgos identificados por municipio</h3>
            <div class="chart-container">
              <canvas id="chart-2-2"></canvas>
            </div>
          </div>
        </section>

        <!-- CAP√çTULO 3 -->
        <section class="chapter amenazas-chapter-3" id="chapter-3" data-chapter="3">
          <!-- T√≠tulo del mapa -->
          <h2 class="map-title">Distribuci√≥n espacial de amenazas clim√°ticas</h2>

          <!-- Mapa -->
          <div class="chapter-map amenazas-chapter-map">
            <div class="map-container" id="map-3"></div>
            <!-- Los controles de capas se generan din√°micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text amenazas-chapter-text">
            <h2 class="chapter-title">Impacto Territorial</h2>
            <div class="chapter-content">
              <p>
               <ul>
                <li><strong>üåµ Sequ√≠a:</strong>Entre 2010 y 2023 prevalecieron condiciones de sequ√≠a "anormalmente seca" (D0), ligadas a la disminuci√≥n de lluvias en la regi√≥n. <br>üîóFuente: <a href="https://smn.conagua.gob.mx/es/climatologia/monitor-de-sequia/monitor-de-sequia-en-mexico" target="_blank">Monitor de sequ√≠as CONAGUA</a></li>
                <li><br></li>
                <li><strong>üî• Fuegos forestales:</strong>Registrados en distintas zonas del estado, con informaci√≥n detallada en el SNIF. <br>üîóFuente: <a href="https://snif.cnf.gob.mx/incendios/" target="_blank">Incendios forestales ‚Äì SNIF</a></li>
                <li><br></li>
                <li><strong>üåä Inundaciones:</strong>Identificadas como amenazas recurrentes en varios municipios. <br>üîóDatos disponibles en: <a href="http://www.atlasnacionalderiesgos.gob.mx/archivo/visor-capas.html" target="_blank">Atlas Nacional de Riesgos</a></li>
                <li><br></li>
                <li><strong>üå≤ Deforestaci√≥n:</strong>Vinculada a la p√©rdida de cobertura vegetal y al aumento de la vulnerabilidad del territorio. <br>üîóFuente: <a href="https://snmf.cnf.gob.mx/sistema-nacional-de-monitoreo-forestal-2/" target="_blank">Sistema Nacional de Monitoreo Forestal</a></li>
                <li><br></li>
                <li><strong>üè≠ Emisi√≥n de contaminantes:</strong>Mencionada como amenaza, pero se recomienda moverla a la secci√≥n de Mitigaci√≥n por su relaci√≥n con reducci√≥n de emisiones y calidad del aire. <br>üîóFuente: <a href="https://gisviewer.semarnat.gob.mx/wmaplicacion/inem/" target="_blank">Inventario Nacional de Emisiones - SEMARNAT</a></li>
               </ul>
              </p>
            </div>
          </div>
        </section>
      </div>

      <!-- Timeline inferior -->
      <div class="timeline" id="timeline">
        <div class="timeline-item" data-chapter="1">
          <div class="timeline-circle">1</div>
          <div class="timeline-label">Amenazas clim√°ticas</div>
        </div>
        <div class="timeline-item" data-chapter="2">
          <div class="timeline-circle">2</div>
          <div class="timeline-label">An√°lisis y Tendencias</div>
        </div>
        <div class="timeline-item" data-chapter="3">
          <div class="timeline-circle">3</div>
          <div class="timeline-label">Impacto Territorial</div>
        </div>
      </div>

      <!-- Botones de navegaci√≥n -->
      <div class="nav-buttons left" id="navButtonsLeft">
        <button class="nav-btn" id="btnPrev" aria-label="Cap√≠tulo anterior">
          ‚Üê
        </button>
      </div>
      <div class="nav-buttons right" id="navButtonsRight">
        <button class="nav-btn" id="btnNext" aria-label="Siguiente cap√≠tulo">
          ‚Üí
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
      import { storyMapConfig } from './js/config/amenazas-config.js';

      // ============================================================
      // INICIALIZACI√ìN PRINCIPAL
      // ============================================================
      window.addEventListener('DOMContentLoaded', () => {
        const capituloActual = storyMapConfig.capitulos[0];
        const proxyUrl = storyMapConfig.proxyUrl;

        // ============================================================
        // CAP√çTULO 1 - MAPA DE AMENAZAS CLIM√ÅTICAS
        // ============================================================
        const map = new ol.Map({
          target: 'map-1',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
              zIndex: 0, 
            }),
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat(capituloActual.mapa.centro),
            zoom: capituloActual.mapa.zoom,
          }),
          controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: false,
          }),
        });


        const capasWMS = [];

        // Detectar si estamos usando proxy de Vercel
        const isVercelProxy = proxyUrl.includes('proxy?path=');

        // Agregar capas WMS
        capituloActual.mapa.capas.forEach((capaConfig, index) => {

          if (capaConfig.tipo === 'subtitulo') {
            capasWMS.push(null);
            return;
          }

          if (capaConfig.tipo === 'wms') {
            const workspace = 'SEICCT';
            let wmsSource;

            if (isVercelProxy) {
              // Para Vercel: usar tileLoadFunction personalizado
              const basePath = `/geoserver/${workspace}/wms`;
              wmsSource = new ol.source.TileWMS({
                url: proxyUrl.replace('?path=', ''),
                params: {
                  'LAYERS': capaConfig.layer,
                  'TILED': true,
                  'VERSION': '1.1.0',
                  'FORMAT': 'image/png',
                  'TRANSPARENT': true,
                },
                serverType: 'geoserver',
                crossOrigin: 'anonymous',
                tileLoadFunction: function(imageTile, src) {
                  const url = new URL(src, window.location.origin);
                  const params = url.searchParams.toString();
                  const fullPath = `${basePath}?${params}`;
                  const encodedPath = encodeURIComponent(fullPath);
                  const finalUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                  imageTile.getImage().src = finalUrl;
                },
              });
            } else {
              // Para local: URL directa
              wmsSource = new ol.source.TileWMS({
                url: proxyUrl + '/SEICCT/wms',
                params: {
                  'LAYERS': capaConfig.layer,
                  'TILED': true,
                },
                serverType: 'geoserver',
              });
            }

            const wmsLayer = new ol.layer.Tile({
              source: wmsSource,
              visible: capaConfig.visible || false,
              opacity: capaConfig.opacity || 1,
              zIndex: capaConfig.zIndex || index,
            });
            wmsLayer.set('name', capaConfig.nombre);
            map.addLayer(wmsLayer);
            capasWMS.push(wmsLayer);
          }


          if (capaConfig.tipo === 'wfs') {
            const typeName = capaConfig.layers;
            const layerParts = typeName.split(':');
            const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

            const vectorSource = new ol.source.Vector({
              format: new ol.format.GeoJSON(),
              url: function(extent) {
                const params = new URLSearchParams({
                  service: 'WFS',
                  version: '1.0.0',
                  request: 'GetFeature',
                  typeName: typeName,
                  outputFormat: 'application/json',
                  srsname: 'EPSG:3857',
                  bbox: `${extent.join(',')},EPSG:3857`
                });

                if (isVercelProxy) {
                  // Para Vercel: URL-encode el path completo
                  const wfsPath = `/geoserver/${workspace}/ows?${params.toString()}`;
                  const encodedPath = encodeURIComponent(wfsPath);
                  return `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                } else {
                  // Para local
                  return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
                }
              },
              strategy: ol.loadingstrategy.bbox
            });

            
            const transparentStyle = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 0, 0)',
                width: 0
              }),
              fill: new ol.style.Fill({
                color: 'rgba(0, 0, 0, 0)'
              })
            });

            const wfsLayer = new ol.layer.Vector({
              source: vectorSource,
              style: transparentStyle,
              visible: true,
              zIndex: 999
            });
            wfsLayer.set('name', capaConfig.nombre);
            wfsLayer.set('tipo', 'wfs');
            map.addLayer(wfsLayer);

            
            configurarHoverMunicipios(map);

            capasWMS.push(null); // Mantener √≠ndice
          }
        });

        generarControlesCapas(capituloActual.mapa.capas, capasWMS);

        /**
         * Configura el hover sobre municipios para mostrar tooltip
         * @param {ol.Map} mapa - Instancia del mapa de OpenLayers
         */
        function configurarHoverMunicipios(mapa) {
          const mapElement = document.getElementById('map-1');
          if (!mapElement) return;

          
          const tooltip = document.createElement('div');
          tooltip.className = 'municipio-hover-tooltip';
          tooltip.style.display = 'none';
          mapElement.appendChild(tooltip);

          
          let currentFeature = null;
          let defaultStyle = null;

          
          const hoverStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: '#A21A5C',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'rgba(162, 26, 92, 0.2)'
            })
          });

          
          mapa.on('pointermove', (evt) => {
            const pixel = mapa.getEventPixel(evt.originalEvent);

            
            if (currentFeature) {
              currentFeature.setStyle(defaultStyle);
              currentFeature = null;
              tooltip.style.display = 'none';
            }

            
            mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
              if (layer && layer.get('tipo') === 'wfs') {
                currentFeature = feature;
                defaultStyle = feature.getStyle() || layer.getStyle();

                
                feature.setStyle(hoverStyle);

                
                const properties = feature.getProperties();
                const nombreMunicipio =
                  properties.Municipio ||
                  properties.MUNICIPIO ||
                  properties.municipio ||
                  properties.nombre ||
                  properties.NOMBRE ||
                  properties.NOM_MUN ||
                  properties.nom_mun ||
                  properties.NOMGEO ||
                  properties.nomgeo ||
                  'Municipio';

                
                tooltip.textContent = nombreMunicipio;
                tooltip.style.display = 'block';
                tooltip.style.left = `${evt.originalEvent.offsetX + 15}px`;
                tooltip.style.top = `${evt.originalEvent.offsetY + 15}px`;

                return true; 
              }
            });
          });
        }

        /**
         * Genera el panel de control de capas con checkboxes
         * @param {Array} capasConfig - Configuraci√≥n de capas desde amenazas-config.js
         * @param {Array} capasWMS - Array de capas WMS de OpenLayers
         */
        function generarControlesCapas(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-1');
          if (!mapContainer || !mapContainer.parentElement) return;

          
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

          
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

          
          capasConfig.forEach((capaConfig, index) => {
            
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

            
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

            
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

            
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                
                actualizarPanelLeyendas(capasConfig, capasWMS);
              });
            }
          });

          
          crearPanelLeyendas(mapContainer.parentElement);
          
          actualizarPanelLeyendas(capasConfig, capasWMS);
        }

        /**
         * Crea el panel de leyendas en el mapa
         * @param {HTMLElement} mapParent - Elemento padre donde se agregar√° el panel
         */
        function crearPanelLeyendas(mapParent) {
          let legendsContainer = mapParent.querySelector('.map-legends');
          if (!legendsContainer) {
            legendsContainer = document.createElement('div');
            legendsContainer.className = 'map-legends';
            legendsContainer.innerHTML = `
              <div class="map-legends-header">
                <div class="map-legends-title">Leyendas</div>
                <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
              </div>
              <div class="map-legends-content"></div>
            `;
            mapParent.appendChild(legendsContainer);

            
            const toggleBtn = legendsContainer.querySelector('.map-legends-toggle');
            toggleBtn.addEventListener('click', () => {
              legendsContainer.classList.toggle('collapsed');
              toggleBtn.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            });
          }
        }

        /**
         * Genera HTML de simbolog√≠a manual desde configuraci√≥n
         * @param {Object} simbologia - Configuraci√≥n de simbolog√≠a
         * @returns {string} HTML de la simbolog√≠a
         */
        function generarSimbologiaHTML(simbologia) {
          let html = '<div class="legend-simbologia">';
          simbologia.categorias.forEach(cat => {
            html += `
              <div class="legend-categoria">
                <span class="legend-simbolo" style="background-color: ${cat.color}; border: 1px solid ${cat.stroke || '#333'};"></span>
                <span class="legend-label">${cat.label}</span>
              </div>
            `;
          });
          html += '</div>';
          return html;
        }

        /**
         * Actualiza el panel de leyendas mostrando solo las capas activas
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function actualizarPanelLeyendas(capasConfig, capasWMS) {
          const legendsContent = document.querySelector('.map-legends-content');
          if (!legendsContent) return;

          legendsContent.innerHTML = '';
          let capasActivas = 0;
          const simbologias = storyMapConfig.simbologias || {};

          capasConfig.forEach((capaConfig, index) => {
            if (capaConfig.tipo !== 'wms' || capaConfig.leyenda === false) return;
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) return;

            const capa = capasWMS[index];
            if (capa && capa.getVisible()) {
              capasActivas++;

              const legendItem = document.createElement('div');
              legendItem.className = 'legend-item';

              const legendTitle = document.createElement('div');
              legendTitle.className = 'legend-item-title';
              legendTitle.textContent = capaConfig.nombre;
              legendItem.appendChild(legendTitle);

              // Verificar si hay simbolog√≠a manual definida
              const simbologia = simbologias[capaConfig.layer];
              if (simbologia) {
                // Usar simbolog√≠a manual
                const simbologiaContainer = document.createElement('div');
                simbologiaContainer.innerHTML = generarSimbologiaHTML(simbologia);
                legendItem.appendChild(simbologiaContainer.firstElementChild);
              } else {
                // Usar imagen de GeoServer como fallback
                const legendImage = document.createElement('img');
                legendImage.className = 'legend-item-image';

                let legendUrl;
                const legendParams = `REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${capaConfig.layer}&WIDTH=15&HEIGHT=15&LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:11;dpi:96;forceLabels:on;fontName:Sans-Serif`;

                if (isVercelProxy) {
                  const legendPath = `/geoserver/SEICCT/wms?${legendParams}`;
                  const encodedLegendPath = encodeURIComponent(legendPath);
                  legendUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedLegendPath}`;
                } else {
                  legendUrl = `${proxyUrl}/SEICCT/wms?${legendParams}`;
                }

                legendImage.src = legendUrl;
                legendImage.alt = `Leyenda de ${capaConfig.nombre}`;
                legendItem.appendChild(legendImage);
              }

              legendsContent.appendChild(legendItem);
            }
          });

          if (capasActivas === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'map-legends-empty';
            emptyMessage.textContent = 'No hay capas activas';
            legendsContent.appendChild(emptyMessage);
          }
        }

        // ============================================================
        // CAP√çTULO 3 - DISTRIBUCI√ìN ESPACIAL DE AMENAZAS
        // ============================================================
        const capitulo3 = storyMapConfig.capitulos[2]; 
        
        if (!capitulo3 || !capitulo3.mapa) {
          console.error('Cap√≠tulo 3 no encontrado o no tiene mapa');
        } else {
          
          const map3 = new ol.Map({
        target: 'map-3',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
            zIndex: 0, 
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(capitulo3.mapa.centro),
          zoom: capitulo3.mapa.zoom,
        }),
        controls: ol.control.defaults.defaults({
          zoom: true,
          attribution: false,
        }),
        });


        const capasWMS3 = [];


        capitulo3.mapa.capas.forEach((capaConfig, index) => {

        if (capaConfig.tipo === 'subtitulo') {
          capasWMS3.push(null);
          return;
        }

        if (capaConfig.tipo === 'wms') {
          const workspace = 'SEICCT';
          let wmsSource3;

          if (isVercelProxy) {
            // Para Vercel: usar tileLoadFunction personalizado
            const basePath3 = `/geoserver/${workspace}/wms`;
            wmsSource3 = new ol.source.TileWMS({
              url: proxyUrl.replace('?path=', ''),
              params: {
                'LAYERS': capaConfig.layer,
                'TILED': true,
                'VERSION': '1.1.0',
                'FORMAT': 'image/png',
                'TRANSPARENT': true,
              },
              serverType: 'geoserver',
              crossOrigin: 'anonymous',
              tileLoadFunction: function(imageTile, src) {
                const url = new URL(src, window.location.origin);
                const params = url.searchParams.toString();
                const fullPath = `${basePath3}?${params}`;
                const encodedPath = encodeURIComponent(fullPath);
                const finalUrl = `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
                imageTile.getImage().src = finalUrl;
              },
            });
          } else {
            // Para local: URL directa
            wmsSource3 = new ol.source.TileWMS({
              url: proxyUrl + '/SEICCT/wms',
              params: {
                'LAYERS': capaConfig.layer,
                'TILED': true,
              },
              serverType: 'geoserver',
            });
          }

          const wmsLayer = new ol.layer.Tile({
            source: wmsSource3,
            visible: capaConfig.visible || false,
            opacity: capaConfig.opacity || 1,
            zIndex: capaConfig.zIndex || index,
          });
          wmsLayer.set('name', capaConfig.nombre);
          map3.addLayer(wmsLayer);
          capasWMS3.push(wmsLayer);
        }


        if (capaConfig.tipo === 'wfs') {
          const typeName = capaConfig.layers;
          const layerParts = typeName.split(':');
          const workspace = layerParts.length > 1 ? layerParts[0] : 'SEICCT';

          const vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
              const params = new URLSearchParams({
                service: 'WFS',
                version: '1.0.0',
                request: 'GetFeature',
                typeName: typeName,
                outputFormat: 'application/json',
                srsname: 'EPSG:3857',
                bbox: `${extent.join(',')},EPSG:3857`
              });

              if (isVercelProxy) {
                // Para Vercel: URL-encode el path completo
                const wfsPath = `/geoserver/${workspace}/ows?${params.toString()}`;
                const encodedPath = encodeURIComponent(wfsPath);
                return `${proxyUrl.replace('?path=', '')}?path=${encodedPath}`;
              } else {
                // Para local
                return `${proxyUrl}/${workspace}/ows?${params.toString()}`;
              }
            },
            strategy: ol.loadingstrategy.bbox
          });

          
          const transparentStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'rgba(0, 0, 0, 0)',
              width: 0
            }),
            fill: new ol.style.Fill({
              color: 'rgba(0, 0, 0, 0)'
            })
          });

          const wfsLayer = new ol.layer.Vector({
            source: vectorSource,
            style: transparentStyle,
            visible: true,
            zIndex: 999
          });
          wfsLayer.set('name', capaConfig.nombre);
          wfsLayer.set('tipo', 'wfs');
          map3.addLayer(wfsLayer);

          
          configurarHoverMunicipios3(map3);

          capasWMS3.push(null); // Mantener √≠ndice
        }
        });

        
        generarControlesCapas3(capitulo3.mapa.capas, capasWMS3);

        /**
         * Configura hover para municipios en el mapa del cap√≠tulo 3
         * @param {ol.Map} mapa - Instancia del mapa de OpenLayers
         */
        function configurarHoverMunicipios3(mapa) {
        const mapElement = document.getElementById('map-3');
        if (!mapElement) return;

       
        const tooltip = document.createElement('div');
        tooltip.className = 'municipio-hover-tooltip';
        tooltip.style.display = 'none';
        mapElement.appendChild(tooltip);

        
        mapa.on('pointermove', (event) => {
          const pixel = mapa.getEventPixel(event.originalEvent);
          let featureDetected = false;

          mapa.forEachFeatureAtPixel(pixel, (feature, layer) => {
            if (layer && layer.get('tipo') === 'wfs') {
              const municipio = feature.get('municipio') || feature.get('MUNICIPIO') || feature.get('Municipio');
              if (municipio) {
                tooltip.textContent = municipio;
                tooltip.style.display = 'block';
                tooltip.style.left = event.pixel[0] + 15 + 'px';
                tooltip.style.top = event.pixel[1] + 15 + 'px';
                featureDetected = true;
              }
            }
          });

          if (!featureDetected) {
            tooltip.style.display = 'none';
          }

          mapa.getTargetElement().style.cursor = featureDetected ? 'pointer' : '';
        });
        }

        /**
         * Genera controles de capas para el mapa del cap√≠tulo 3
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function generarControlesCapas3(capasConfig, capasWMS) {
          const mapContainer = document.getElementById('map-3');
          if (!mapContainer || !mapContainer.parentElement) return;

         
          let controlsContainer = mapContainer.parentElement.querySelector('.map-controls');
          if (!controlsContainer) {
            controlsContainer = document.createElement('div');
            controlsContainer.className = 'map-controls';
            mapContainer.parentElement.appendChild(controlsContainer);
          }

          
          controlsContainer.innerHTML = `
            <div class="map-controls-header">
              <div class="map-controls-title">Capas</div>
              <button class="map-controls-toggle" title="Ocultar/Mostrar capas">‚ñ≤</button>
            </div>
            <div class="map-controls-content"></div>
          `;

        
          const contentContainer = controlsContainer.querySelector('.map-controls-content');

          
          const toggleBtn = controlsContainer.querySelector('.map-controls-toggle');
          toggleBtn.addEventListener('click', () => {
            controlsContainer.classList.toggle('collapsed');
            toggleBtn.textContent = controlsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
          });

         
          capasConfig.forEach((capaConfig, index) => {
           
            if (capaConfig.tipo === 'subtitulo') {
              const subtitulo = document.createElement('div');
              subtitulo.className = 'layer-group-title';
              subtitulo.textContent = capaConfig.titulo;
              contentContainer.appendChild(subtitulo);
              return;
            }

           
            if (capaConfig.nombre && capaConfig.nombre.includes('Interacci√≥n')) {
              return;
            }

           
            if (capaConfig.leyenda === false) {
              return;
            }

            const checkboxId = `layer-3-${index}`;
            const isVisible = capaConfig.visible || false;
            const layerControl = document.createElement('div');
            layerControl.className = 'layer-control';
            layerControl.innerHTML = `
              <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''} />
              <label for="${checkboxId}">${capaConfig.nombre}</label>
            `;
            contentContainer.appendChild(layerControl);

          
            const checkbox = layerControl.querySelector(`#${checkboxId}`);
            if (checkbox && capasWMS[index]) {
              checkbox.addEventListener('change', (e) => {
                capasWMS[index].setVisible(e.target.checked);
                
                actualizarPanelLeyendas3(capasConfig, capasWMS);
              });
            }
          });

          
          crearPanelLeyendas3(mapContainer.parentElement);
         
          actualizarPanelLeyendas3(capasConfig, capasWMS);
        }

        /**
         * Crea panel de leyendas para el mapa del cap√≠tulo 3
         * @param {HTMLElement} mapParent - Elemento padre
         */
        function crearPanelLeyendas3(mapParent) {
        let legendsContainer = mapParent.querySelector('.map-legends');
        if (legendsContainer) return; 

        legendsContainer = document.createElement('div');
        legendsContainer.className = 'map-legends';
        mapParent.appendChild(legendsContainer);

        legendsContainer.innerHTML = `
          <div class="map-legends-header">
            <div class="map-legends-title">Leyendas</div>
            <button class="map-legends-toggle" title="Ocultar/Mostrar leyendas">‚ñ≤</button>
          </div>
          <div class="map-legends-content"></div>
        `;

        const toggleButton = legendsContainer.querySelector('.map-legends-toggle');
        toggleButton.addEventListener('click', () => {
          legendsContainer.classList.toggle('collapsed');
          toggleButton.textContent = legendsContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        });
        }

        /**
         * Actualiza panel de leyendas del cap√≠tulo 3
         * @param {Array} capasConfig - Configuraci√≥n de capas
         * @param {Array} capasWMS - Array de capas WMS
         */
        function actualizarPanelLeyendas3(capasConfig, capasWMS) {
        const mapContainer = document.getElementById('map-3');
        if (!mapContainer || !mapContainer.parentElement) return;

        const legendsContainer = mapContainer.parentElement.querySelector('.map-legends');
        if (!legendsContainer) return;

        const legendsContent = legendsContainer.querySelector('.map-legends-content');
        legendsContent.innerHTML = '';

        let capasActivas = 0;
        const simbologias = storyMapConfig.simbologias || {};

        capasConfig.forEach((capaConfig, index) => {
          if (capaConfig.tipo !== 'wms' || !capaConfig.leyenda) return;

          const capa = capasWMS[index];
          if (capa && capa.getVisible()) {
            capasActivas++;

            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const legendTitle = document.createElement('div');
            legendTitle.className = 'legend-item-title';
            legendTitle.textContent = capaConfig.nombre;
            legendItem.appendChild(legendTitle);

            // Verificar si hay simbolog√≠a manual definida
            const simbologia = simbologias[capaConfig.layer];
            if (simbologia) {
              // Usar simbolog√≠a manual
              const simbologiaContainer = document.createElement('div');
              simbologiaContainer.innerHTML = generarSimbologiaHTML(simbologia);
              legendItem.appendChild(simbologiaContainer.firstElementChild);
            } else {
              // Usar imagen de GeoServer como fallback
              const legendImage = document.createElement('img');
              legendImage.className = 'legend-item-image';

              let legendUrl3;
              const legendParams3 = `REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${capaConfig.layer}&WIDTH=15&HEIGHT=15&LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:11;dpi:96;forceLabels:on;fontName:Sans-Serif`;

              if (isVercelProxy) {
                const legendPath3 = `/geoserver/SEICCT/wms?${legendParams3}`;
                const encodedLegendPath3 = encodeURIComponent(legendPath3);
                legendUrl3 = `${proxyUrl.replace('?path=', '')}?path=${encodedLegendPath3}`;
              } else {
                legendUrl3 = `${proxyUrl}/SEICCT/wms?${legendParams3}`;
              }

              legendImage.src = legendUrl3;
              legendImage.alt = `Leyenda de ${capaConfig.nombre}`;
              legendItem.appendChild(legendImage);
            }

            legendsContent.appendChild(legendItem);
          }
        });


        if (capasActivas === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'map-legends-empty';
          emptyMessage.textContent = 'No hay capas activas';
          legendsContent.appendChild(emptyMessage);
        }
        }
        }

        // ============================================================
        // NAVEGACI√ìN Y CONTROLES
        // ============================================================
        const navbarToggle = document.getElementById("navbarToggle");
        const navbarMenu = document.getElementById("navbarMenu");

        
        navbarToggle.addEventListener("click", () => {
          navbarToggle.classList.toggle("active");
          navbarMenu.classList.toggle("active");
        });

        
        const navbarLinks = document.querySelectorAll(".navbar-link");
        navbarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            navbarToggle.classList.remove("active");
            navbarMenu.classList.remove("active");
          });
        });

        
        const navbar = document.querySelector(".navbar");
        const navbarIndicator = document.getElementById("navbarIndicator");

        
        window.addEventListener("scroll", () => {
          if (window.scrollY > 50) {
            navbar.classList.add("scrolled");
          } else {
            navbar.classList.remove("scrolled");
          }
        });

  
        navbarIndicator.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

        
        navbar.addEventListener("mouseenter", () => {
          navbar.classList.add("visible");
        });

       
        navbar.addEventListener("mouseleave", () => {
          navbar.classList.remove("visible");
        });

        
        navbarIndicator.addEventListener("click", () => {
          navbar.classList.toggle("visible");
        });

        // ============================================================
        // NAVEGACI√ìN ENTRE CAP√çTULOS
        // ============================================================
        const chaptersContainer = document.getElementById("chaptersContainer");
        const timelineItems = document.querySelectorAll(".timeline-item");
        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");

        let currentChapter = 1;
        const totalChapters = 3;

        /**
         * Navega a un cap√≠tulo espec√≠fico con scroll suave
         * @param {number} chapterNum - N√∫mero del cap√≠tulo (1-3)
         */
        function goToChapter(chapterNum) {

          if (chapterNum < 1 || chapterNum > totalChapters) {

            return;
          }

          currentChapter = chapterNum;

          
          timelineItems.forEach(item => {
            const itemChapter = parseInt(item.dataset.chapter);
            if (itemChapter === currentChapter) {
              item.classList.add("active");
            } else {
              item.classList.remove("active");
            }
          });

         
          const targetChapter = document.getElementById(`chapter-${chapterNum}`);
  
          if (targetChapter) {
            targetChapter.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            console.error(`No se encontr√≥ el elemento chapter-${chapterNum}`);
          }
        }

        
        timelineItems.forEach(item => {
          item.addEventListener("click", () => {
            const chapterNum = parseInt(item.dataset.chapter);

            goToChapter(chapterNum);
          });
        });



       
        btnPrev.addEventListener("click", () => {

          goToChapter(currentChapter - 1);
        });

        btnNext.addEventListener("click", () => {

          goToChapter(currentChapter + 1);
        });

        
        goToChapter(1);
      }); 
    </script>
  </body>
</html>
