<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Story Map sobre las Amenazas Clim&aacute;ticas en Tlaxcala"
    />
    <title>Amenazas Clim&aacute;ticas - Tlaxcala</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/story-map.css" />

    <!-- OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <!-- Papa Parse para CSVs -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-brand">
          <!--         <span class="navbar-brand-icon">&#127757;</span> -->
          <span>Tlaxcala</span>
        </a>

        <button class="navbar-toggle" id="navbarToggle" aria-label="Abrir men&uacute;">
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
          <span class="navbar-toggle-line"></span>
        </button>

        <div class="navbar-menu" id="navbarMenu">
          <a href="index.html" class="navbar-link">Inicio</a>
          <a href="vulnerabilidad.html" class="navbar-link">Vulnerabilidad</a>
          <a href="riesgo.html" class="navbar-link">Riesgo</a>
          <a href="amenazas.html" class="navbar-link active">Amenazas</a>
          <a href="impactos.html" class="navbar-link">Impactos</a>
          <a href="acciones-climaticas.html" class="navbar-link">Acciones Clim&aacute;ticas</a>
        </div>
      </div>
    </nav>

    <!-- Indicador para mostrar el navbar -->
    <div class="navbar-indicator" id="navbarIndicator"></div>

    <!-- Contenedor principal del Story Map -->
    <div class="story-map-container">
      <!-- Contenedor de cap&iacute;tulos con scroll-snap -->
      <div class="chapters-container" id="chaptersContainer">
        <!-- CAP&Iacute;TULO 1 -->
        <section class="chapter" id="chapter-1" data-chapter="1">
          <!-- T&iacute;tulo del mapa -->
          <h2 class="map-title">Amenazas clim&aacute;ticas por municipio</h2>

          <!-- Mapa -->
          <div class="chapter-map">
            <div class="map-container" id="map-1"></div>
            <!-- Los controles de capas se generan din&aacute;micamente -->
          </div>

          <!-- Card de texto -->
          <div class="chapter-text">
            <!-- <span class="chapter-number">Cap&iacute;tulo 1</span> -->
            <h2 class="chapter-title">
              Amenazas clim&aacute;ticas
            </h2>
            <div class="chapter-content">
              <p>
                Las amenazas clim&aacute;ticas son eventos o fen&oacute;menos relacionados con el clima que pueden causar da&ntilde;os o p&eacute;rdidas:
              </p>
              <p>
                <ul>
                  <li>* Temperaturas extremas.</li>
                  <li>* Lluvias intensas.</li>
                  <li>* Sequ&iacute;as prolongadas.</li>
                  <li>* Fen&oacute;menos meteorol&oacute;gicos extremos.</li>
                </ul>
              </p>
              <p>
                Estas amenazas representan peligros potenciales para las comunidades, los ecosistemas y la infraestructura del estado.
              </p>
            </div>
          </div>

<!-- Card combinada de gr&aacute;fico e info (sin borde entre ellas) -->
<div class="chapter-chart-info">
  <!-- T&iacute;tulo &uacute;nico para toda la card -->
  <h2 class="chart-info-title">Poblaci&oacute;n expuesta a amenazas clim&aacute;ticas</h2>

  <div class="chart-info-content">
    <!-- Secci&oacute;n del gr&aacute;fico -->
    <div class="chart-section">
      <div class="chart-container">
        <canvas id="chart-1"></canvas>
      </div>
    </div>

    <!-- Secci&oacute;n de texto explicativo -->
    <div class="info-section">
      <div class="info-content">
        <p>
          Las amenazas clim&aacute;ticas son eventos hidrometeorol&oacute;gicos extremos que pueden impactar negativamente a la poblaci&oacute;n y al territorio. La identificaci&oacute;n y el an&aacute;lisis de estas amenazas son fundamentales para la planificaci&oacute;n territorial y la gesti&oacute;n del riesgo. Para conocer a detalle las variables y su an&aacute;lisis, te invitamos a consultar el PACCET 2023-2030.
        </p>
      </div>
    </div>
  </div>
</div>
        </section>
      </div>

      <!-- Timeline inferior -->
      <div class="timeline" id="timeline">
        <div class="timeline-item" data-chapter="1">
          <div class="timeline-circle">1</div>
          <div class="timeline-label">Amenazas clim&aacute;ticas</div>
        </div>
      </div>

      <!-- Botones de navegaci&oacute;n -->
      <div class="nav-buttons left" id="navButtonsLeft">
        <button class="nav-btn" id="btnPrev" aria-label="Cap&iacute;tulo anterior">
          ←
        </button>
      </div>
      <div class="nav-buttons right" id="navButtonsRight">
        <button class="nav-btn" id="btnNext" aria-label="Siguiente cap&iacute;tulo">
          →
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
      import { storyMapConfig } from './js/config/amenazas-config.js';

      // ===== INICIALIZACIÓN DEL MAPA =====
      document.addEventListener('DOMContentLoaded', () => {
        const capituloActual = storyMapConfig.capitulos[0]; // Capítulo 1

        // Crear el mapa
        const map = new ol.Map({
          target: 'map-1',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
            }),
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat(capituloActual.mapa.centro),
            zoom: capituloActual.mapa.zoom,
          }),
          controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: false,
          }),
        });

        // Agregar capas WMS
        capituloActual.mapa.capas.forEach(capaConfig => {
          if (capaConfig.tipo === 'wms') {
            const wmsLayer = new ol.layer.Tile({
              source: new ol.source.TileWMS({
                url: capaConfig.url,
                params: {
                  'LAYERS': capaConfig.layers,
                  'TILED': true,
                },
                serverType: 'geoserver',
              }),
              visible: capaConfig.visible,
            });
            map.addLayer(wmsLayer);
          }
        });

        // Cargar y renderizar el gráfico
        if (capituloActual.grafico) {
          Papa.parse(capituloActual.grafico.datos, {
            download: true,
            header: true,
            complete: (results) => {
              const ctx = document.getElementById('chart-1').getContext('2d');
              const config = capituloActual.grafico.config;

              const labels = results.data.map(row => row[config.etiqueta]);
              const valores = results.data.map(row => parseFloat(row[config.valor]));

              new Chart(ctx, {
                type: capituloActual.grafico.tipo,
                data: {
                  labels: labels,
                  datasets: [{
                    data: valores,
                    backgroundColor: config.colores,
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: config.mostrarLeyenda,
                      position: 'right',
                    },
                  },
                },
              });
            }
          });
        }
      });

      // ===== NAVBAR =====
      const navbarToggle = document.getElementById("navbarToggle");
      const navbarMenu = document.getElementById("navbarMenu");

      // Toggle menú móvil
      navbarToggle.addEventListener("click", () => {
        navbarToggle.classList.toggle("active");
        navbarMenu.classList.toggle("active");
      });

      // Cerrar menú al hacer click en un link
      const navbarLinks = document.querySelectorAll(".navbar-link");
      navbarLinks.forEach((link) => {
        link.addEventListener("click", () => {
          navbarToggle.classList.remove("active");
          navbarMenu.classList.remove("active");
        });
      });

      // Navbar y navbar indicator
      const navbar = document.querySelector(".navbar");
      const navbarIndicator = document.getElementById("navbarIndicator");

      // Efecto scroll en navbar
      window.addEventListener("scroll", () => {
        if (window.scrollY > 50) {
          navbar.classList.add("scrolled");
        } else {
          navbar.classList.remove("scrolled");
        }
      });

      // Mostrar/ocultar navbar con el indicador

      // Mostrar navbar al hacer hover sobre el indicador
      navbarIndicator.addEventListener("mouseenter", () => {
        navbar.classList.add("visible");
      });

      // Mantener navbar visible mientras el mouse está sobre él
      navbar.addEventListener("mouseenter", () => {
        navbar.classList.add("visible");
      });

      // Ocultar navbar cuando el mouse sale
      navbar.addEventListener("mouseleave", () => {
        navbar.classList.remove("visible");
      });

      // Click en indicador para toggle del navbar
      navbarIndicator.addEventListener("click", () => {
        navbar.classList.toggle("visible");
      });
    </script>
  </body>
</html>
